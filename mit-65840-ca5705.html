<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fb143553a-62bb-4561-8744-efc9017c43b0%2Fa7cee299-b32f-4387-a829-55965daa3299%2Fcat.jpg?table=collection&amp;id=a1b4dbf5-8bef-463d-bf08-b55c43072e4b">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>MIT 6.5840&nbsp;|&nbsp;躺平仔乐园</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="MIT 6.5840">
  
    <meta name="description" content="MIT 6.5840 note">
    <meta property="og:description" content="MIT 6.5840 note">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;➕&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fb143553a-62bb-4561-8744-efc9017c43b0%2Fa7cee299-b32f-4387-a829-55965daa3299%2Fcat.jpg?table=collection&amp;id=a1b4dbf5-8bef-463d-bf08-b55c43072e4b"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🌖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;➕&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">MIT 6.5840</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Apr 28, 2023</span>
        
        
      </div>
    
  </header>
  <article id="https://www.notion.so/ca570599ff8b4661a15d8086770b3630" class="PageRoot"><div id="https://www.notion.so/d47da8ac80da41838b4bda73cbc7fb85" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">😇</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">All I need to know about 6.5840
Full code on:
</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/humbornjo/MIT-6.5840">https://github.com/humbornjo/MIT-6.5840</a></span></span></p></div><h1 id="https://www.notion.so/26409dbfc310415e85fae4e4d2379924" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/26409dbfc310415e85fae4e4d2379924"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Lab1</span></span></h1><div id="https://www.notion.so/547211e6a0a64eca902d9952ffebc414" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">虽然本次实验没有触及，但是GFS才是Map Reduce的灵魂。这也是很多MR方法局限在单机运行的根本原因。在分布式的场景中，intermediate的交换才是事实上的重点。</span></span></p></div><h2 id="https://www.notion.so/0bf9517b752a42de8875ae4366399f49" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0bf9517b752a42de8875ae4366399f49"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Difficulties &amp; solution</span></span></h2><details id="https://www.notion.so/9a0f47cc241d4c069844df9b08fc4762" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">coordinator 作为调度者，就算其元素都是线程安全的，依然是需要加一个整体的锁的。（仅针对我的设计与实现）</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/ba46b4c45e8e4db4a2ad3fab9e7b8029" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>type Coordinator struct {
	// Your definitions here.
	nMap     int
	nReduce  int
	stage    int
	currTask chan Task
	runnTask map[Task]chan int
	lock     sync.RWMutex
}</span></span></span></code></pre><div id="https://www.notion.so/fc7bd60083ae4c9d978c823a9cb823f2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在我的实现中，当currTask和runnTask全为空时方可触发stage的转换（比如从MAP转移到REDUCE）。如果分别加锁，就可能导致 → </span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/fd8dee5496334dec8143b1ea959d0250" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">检查currTask时为空</span></span></li><li id="https://www.notion.so/7f91de613fcb422ea639ae2dd1d15422" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">runnTask超时，删除任务，未完成的任务重新入队currTask</span></span></li><li id="https://www.notion.so/ea00b790f082401784cb108f508819a9" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">检查runnTask，也为空</span></span></li><li id="https://www.notion.so/5f5fda101a1f412ba4e9cb9d1bf8d408" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">状态转换了，MR失败</span></span></li></ol></div></details><details id="https://www.notion.so/ff712cf2b26e43f9b4ae689c93a1d2e2" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">rpc的设计与细节</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/9aa497843ccb4ffc97dcf4a0b04292e8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/*
type Task struct {
	Tid   int
	Fname string
}
*/

type AskForTaskArgs struct {
	Wid int
}

type AskForTaskReply struct {
	Stage int
	Task  Task
	Nout  int
}

type ReportForTaskArgs struct {
	Task Task
}

type ReportForTaskReply struct {
	Foo bool
}</span></span></span></code></pre><div id="https://www.notion.so/91a5ebeea75e435f8556433ba5df6608" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">总体分为Ask和Report两种，主要的问题在于Report RPC前后临时文件的保存和状态的转变，下面进行分类分析。</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/4d90332e2add4d9aa24690d5f5ac98e3" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">MAP阶段的Report,是在RPC获得true的回复后进行保存临时文件，还是先保存临时文件，再call RPC。</span></span><ol class="NumberedListWrapper"><li id="https://www.notion.so/a9b2d0f84ce04f1b9cf0610658f66a8a" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">如果在获得RPC回复后再保存。如果RPC结果为true（在我的实现中，是</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">reply.Foo == true</code></span><span class="SemanticString">）。会出现一个恐怖的事，那就是coordinator已经转换状态了。开始分发REDUCE的任务了，但是MAP阶段的intermediate文件还没有保存完。这就会导致，如果有一个Worker此时恰好接了任务，并竞争运行了，然而目标文件甚至不存在，最终REDUCE的任务结果出错。如果RPC结果为false，影响不大，就算保存了也会被另一个Worker的文件写入替换。</span></span></li><li id="https://www.notion.so/c5799c68b4e64377ae3447734a929da8" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">如果在获得RPC回复前再保存。如果RPC结果为true，不会有任何问题，解决了上方的问题。如果RPC结果为false，影响不大，就算保存了也会被另一个Worker的文件写入替换。</span></span></li><li id="https://www.notion.so/167b910ef7a14c6cbda52cf9797c850c" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">综上，选择在RPC回复前保存。</span></span></li></ol></li><li id="https://www.notion.so/9077c348f2b5479b8a8636d372cf2e37" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Reduce阶段的Report，没啥好说的，保存必然是在RPC之前的，因为实现borrow了mrsequential的代码，目前来看，换成在RPC之后阻塞地保存，唯一的风险就是Worker的临时宕机。（最后不要忘了删除临时文件）</span></span><pre id="https://www.notion.so/25aa635c2ae74ffdb8e1ae7290f6567d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if !ReportForTask(
	&amp;ReportForTaskArgs{Task: reply.Task}, 
	&amp;ReportForTaskReply{}) {
	os.Remove(oname)
} else {
	for _, filename := range filenames {
		os.Remove(filename)
	}
}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/18ad3f1ff97649e3815aa554ef161e9d" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/511ee97ec3d2446b9fdd13a5fc9bd967" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>MIT-6.5840/src/main via 🐹 v1.20.6 
<span class="token operator">></span> <span class="token function">bash</span> test-mr.sh
*** Starting <span class="token function">wc</span> test.
--- <span class="token function">wc</span> test: PASS
*** Starting indexer test.
--- indexer test: PASS
*** Starting map parallelism test.
--- map parallelism test: PASS
*** Starting reduce parallelism test.
--- reduce parallelism test: PASS
*** Starting job count test.
--- job count test: PASS
*** Starting early <span class="token builtin class-name">exit</span> test.
--- early <span class="token builtin class-name">exit</span> test: PASS
*** Starting crash test.
--- crash test: PASS
*** PASSED ALL TESTS</span></span></span></code></pre></div></div><h1 id="https://www.notion.so/29a16d4cf2ec45dc8ed0e1bb6a711ed7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/29a16d4cf2ec45dc8ed0e1bb6a711ed7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Lab2</span></span></h1><div id="https://www.notion.so/b607df8a45b9429fb732810220e27468" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">What u deserve to understand is that, even raft can make mistake. When the delay is high and command flood in.</span></span></p></div><h2 id="https://www.notion.so/6fa392768d0e400fb248a89454ea345e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6fa392768d0e400fb248a89454ea345e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Core Idea</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/09d59d8f7f964e47917e3fdde3d80793" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Raft RPCS is idempotent</span></span></li><li id="https://www.notion.so/25857d01645344b190de048af86672ca" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Randomization causes simplicity</span></span></li><li id="https://www.notion.so/0fd6e313aacf475a9006741b08c71cf5" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">Leader takes it all</span></span></li><li id="https://www.notion.so/a96aa3528a184d9cb2d093f55bf0f903" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">Logical timing instead of physical timing</span></span></li></ol><p id="https://www.notion.so/ab2f4293d4424fac8cbc892f6d34abd0" class="Equation" data-latex="broadcastTime ≪ electionTimeout ≪ MTBF"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>r</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>c</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>≪</mo><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>≪</mo><mi>M</mi><mi>T</mi><mi>B</mi><mi>F</mi></mrow><annotation encoding="application/x-tex">broadcastTime ≪ electionTimeout ≪ MTBF</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span></span></span></span></span></p><h2 id="https://www.notion.so/08b81fe39f8c4ee2b8cec6885acc32d6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/08b81fe39f8c4ee2b8cec6885acc32d6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Mind Trail</span></span></h2><a id="https://www.notion.so/6ef8a5c635664b7dad1d57c790f5e4df" class="Page" href="https://www.notion.so/6ef8a5c635664b7dad1d57c790f5e4df"><div><div class="Page__Icon"><div class="Icon">✔️</div></div><div class="Page__Title"><span class="SemanticStringArray"><span class="SemanticString">lab2 Raft</span></span></div></div></a><h2 id="https://www.notion.so/eab1eca57d6a413fbbe5ceecf137481b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/eab1eca57d6a413fbbe5ceecf137481b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Difficulties &amp; solution</span></span></h2><h3 id="https://www.notion.so/f3e7e37991f94225862cdc82e385b4ff" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f3e7e37991f94225862cdc82e385b4ff"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2A</span></span></h3><div id="https://www.notion.so/605aa329d3a141599bfe575b0664fbf8" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Term严格小的才能给Term大的server投票，但是容易出现以下情况 (忽略第三列)，即server S1和S2几乎以同一时间开始选举 (即使存在随机timeout)，导致多轮都无法选出leader。</span></span></del></div></div></div><details id="https://www.notion.so/b03c213eaa7a4f66941ccb3c10c1827e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/b21828d32d5a4832b90ff3970e343060" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 C0 ask for vote, T: 8                                                                                                                                     
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 7                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 8                            
                                                     S1 C0 ask for vote, T: 8                                                                                
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 8                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 9                            
                                                     S1 not leader, election timeout...                                                                      
                                                     S1 convert to candidate, calling election T: 8                                                          
                                                                                                         S2 C0 ask for vote, T: 9                            
                                                     S1 C0 ask for vote, T: 9                                                                                
S0 C0 ask for vote, T: 9                                                                                                                                     
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 9                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 10                           
                                                     S1 C0 ask for vote, T: 10                                                                               
                                                     S1 not leader, election timeout...                                                                      
                                                     S1 convert to candidate, calling election T: 9                                                          
                                                                                                         S2 C0 ask for vote, T: 10                           
S0 C0 ask for vote, T: 10                                                                                                                                    
S0 -&gt; S1 vote false, VT: 0                                                                                                                                   
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 10</span></span></span></code></pre></div></details><details id="https://www.notion.so/7629db759b254a7498d3be63f20896c4" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/b31b0909f74249fd965198c2194d7703" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在RequestVote RPCs中就更新了自己的Term，使得落后的server一下子就追上了因random而领先的server</span></span></li><li id="https://www.notion.so/f5d4eadb8aaf4762acf80196922c88a3" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">timeout区间为 [150, 300] ms</span></span></li></ol></div></details><details id="https://www.notion.so/41cbd3f899fc40f8bc772c27c6cd8aaa" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">可能的解决办法</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/64c3dfc68def4dfea1c324c8add64135" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike">不在RequestVote RPCs中更新Term。
</del></span><span class="SemanticString">在更新以后把isTimeout置为false，跳过一轮选举自增。</span></span></li><li id="https://www.notion.so/fdb44b1cfd8549d0be5c92b819916352" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">增大timeout的区间</span></span></li></ol></div></details><details id="https://www.notion.so/ec4dc3f6fde24fce80252296902193a7" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/2797780a8f2f45b4a562c4fb2a486df3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">采用了方法1，并将timeout区间修改为 [200, 500] ms，暂时解决问题。</span></span></p></div></div></details><div id="https://www.notion.so/9e4e8ad549e8409b8079a42edd1cc730" class="Divider"></div><div id="https://www.notion.so/17b7ed1226a946a8aa52f09b1c5a1e22" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">观察第二列和最后一列，可以发现这里 S1 和 S6 出现了脑裂现象，但是并未得到解决。原因是两方此时的Term相同，两方互相会拒绝对方的heartbeat log而不会进行状态转换。</span></span></del></div></div></div><details id="https://www.notion.so/72b781cd918e4bd7a8f1f3dfa5f9fb54" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/6375c1ab8b9049379e02364e165bbc8c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>                       S1 multi leaders(2)                                                                                                                 
                       T: 7                                                                                                                                
                                                                                                                                     S6 multi leaders(2) T:
                                                                                                                                     7                     
                                                                                                                                     S6 -&gt; S5 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                       S1 -&gt; S6 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                                             S2 convert to                                                                                                 
                                             candidate, calling                                                                                            
                                             election T: 7                                                                                                 
                                                                                                                                     S6 C0 ask for vote, T:
                                                                                                                                     8                     
                                                                                                                                     S6 -&gt; S0 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S1 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S2 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S3 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S4 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                       S1 -&gt; S0 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S2 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S3 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S4 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S5 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}</span></span></span></code></pre></div></details><details id="https://www.notion.so/f8446fca0e8c4e08b5e57007d6b86606" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/45fb4851545c4f74bd4140caa060bd26" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Term相同，在身为leader的同时对峙，由于拒绝了heartbeat log导致的状态无法转换</span></span></li></ol></div></details><details id="https://www.notion.so/abd13b41aa774c57ac9b7fdcae8c06ef" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">可能的解决方法</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/2abefa41f3be4e49b1764ae6a98696a9" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">本质上是在disconnect的时候没有检查自己的killed()，及时转换为follower。论文中没有提到Term相同的情况下Entry (Including heartbeat)的处理情况。</span></span></li></ol></div></details><details id="https://www.notion.so/edbd0e3224b04c068922874c30b67686" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/d6164cc87bb34a50825676dfcb318e7b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在每个heartbeat loop中检查killed()，及时转换状态。</span></span></li><li id="https://www.notion.so/f5dc01e6e21a45468ed323697f27844c" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">运行时又发现了一个小问题，下面分析出问题的代码。AppendEntry分为三个情况，currTerm &lt; args.Term, currTerm = args.Term 和 currTerm &gt; args.Term。</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">第一种情况</strong></span><span class="SemanticString">没啥好说的，</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">第二种情况下</strong></span><span class="SemanticString">，若server还未投票 (voteFor == -1) 则server一定不是Leader；投了票的情况下拒绝可以保证一个Term只投一次票的原则。第三种情况下，需要注意，server的状态可能是三个状态中的任意一种，所以一定要重置server的状态为Follower来保证Term大的优先的原则。</span></span></li></ol><pre id="https://www.notion.so/364d4adfbd824befa722ee82938a5b16" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if rf.currTerm &gt; args.Term {
	reply.VoteGranted = false
	DebugLog(dVote, &quot;S%d -&gt; S%d vote false, T: %d, CT: %d\n&quot;, rf.me, args.CandidateId, rf.currTerm, args.Term)
	return
} else if rf.currTerm == args.Term {
	if rf.votedFor == -1 {
		rf.votedFor = args.CandidateId
		reply.VoteGranted = true
		DebugLog(dVote, &quot;S%d -&gt; S%d vote true, same term\n&quot;, rf.me, args.CandidateId)
		return
	} else {
		reply.VoteGranted = false
		DebugLog(dVote, &quot;S%d -&gt; S%d vote false, VT: %d\n&quot;, rf.me, args.CandidateId, rf.votedFor)
		return
	}
} else {
	rf.currTerm = args.Term
	rf.isTimeout = false
	rf.state = Follower // !!!!!!!!!!!!!! IMPORTANT !!!!!!!!!!!!!!
	rf.votedFor = args.CandidateId
	reply.VoteGranted = true
	DebugLog(dVote, &quot;S%d -&gt; S%d vote true, from T: %d to CT: %d\n&quot;, rf.me, args.CandidateId, reply.Term, rf.currTerm)
	return
}</span></span></span></code></pre></div></details><div id="https://www.notion.so/fabb2e4adc2b45599f4b8de06ac70a63" class="Divider"></div><div id="https://www.notion.so/16a392fd50164c68aa28e5ee4e794432" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/d0c3788848874dde882bb4721967ed7b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>humborn@shin MIT-6.5840/src/raft on master [!] [!]                                                                                        󱑆 09:36:06
 ➜ go test -run 2A                                    
Test (2A): initial election ...
  ... Passed --   3.0  3   58   15440    0
Test (2A): election after network failure ...
  ... Passed --   4.4  3  140   27904    0
Test (2A): multiple elections ...
  ... Passed --   6.2  7  686  129664    0
PASS
ok      6.824/raft      13.599s</span></span></span></code></pre></div></div><div id="https://www.notion.so/c29551f9871a42d996a238e5fcaa7dda" class="Divider"></div><div id="https://www.notion.so/be45045ec3e14eae8607ac086be6caae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/7227d34865d647ca979391b945c429f5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/7227d34865d647ca979391b945c429f5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2B</span></span></h3><div id="https://www.notion.so/d89bd40651634125bc6a1b8cf594dcf3" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Server在成功append以后，竟然没有让Leader更新commitIndex</span></span></del></div></div></div><details id="https://www.notion.so/dbf29318f1ec4885a273cc72e10cf9d5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/9c671f61d7084171adb6aac8e881ce8d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 not leader, election timeout...                                                                                                                         
                                        S1 -&gt; S2 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
                                                                               S2 not leader, election timeout...                                          
                                        S1 -&gt; S2 T: 1, send {PLI: 1, PLT: 1,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 1, PLT: 1,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
                                        S1 -&gt; S2 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
FAIL
FAIL    6.824/raft      2.313s</span></span></span></code></pre></div></details><details id="https://www.notion.so/18d358ebf5394e7f9bcc7fdac9bece12" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/4b874fbd61564ebd9295b6bd86c9459b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">sort中索引有问题，原来是从小到大排序后，取len(rf.peers)/2-1，当#Server为3时，结果为0,很显然不对。</span></span></li><li id="https://www.notion.so/7eac1410f7ed4696a30e15f2d64300eb" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">搞错索引了，AppendEntries时可能会传入空Entries。这时想普适地满足AppendEntries RPCs的最后一条实现规则，就需要取server自身logEntries的最后一条entry的index</span></span></li><li id="https://www.notion.so/c1d128eec75548d09542b293f384d79a" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">创建新logEntry时index和term位置反了，cao!</span></span></li></ol></div></details><details id="https://www.notion.so/4afce0da520c4ab3a8df19cbbcdb0688" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/4bf00e546fd84a9bbc309f28d319e03e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">改为(len(rf.peers)-1)/2</span></span></li><li id="https://www.notion.so/ac59d673390d4300ac7fa5621f0c3f61" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">由args.Entries→rf.logEntries取最后一个entry的index</span></span></li><li id="https://www.notion.so/64ed1d6dda8947ada5019fcdd8242751" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">cao！</span></span></li></ol></div></details><details id="https://www.notion.so/585f9a294dcb4429882b927b52dcc991" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Task log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/adef53bd473c4e0e9ce81187d7309ba9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>➜ go test -run BasicAgree                          
Test (2B): basic agreement ...
  ... Passed --   0.5  3   16    4258    3
PASS
ok      6.824/raft      0.494s</span></span></span></code></pre></div></details><div id="https://www.notion.so/fddcd36ee5844cf88ececa59c887248b" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">如果一个server掉线了，会不断</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">StartElection()</code></span><span class="SemanticString">自增，当它重联时，它的Term将会很大。就会导致一个情况，当前 leader 的 AppendEntries RPCs 将会被拒绝，reply中的Term巨大，会将Leader打回Follower并更新Term,最好给Leader特权，让Leader尽快timeout,再次成为Leader；由它召开的Election也会被其他server拒绝(LastLogIndex很小)并使其他server更新Term，不用给特权通道。但是在下方log中
</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">S0 apply msg: {true 101 1 false [] 0 0} 
</em></span><span class="SemanticString">重复出现，且重联后，并未一直尝试Append(在第一次被拒绝后)导致没有及时更新。</span></span></del></div></div></div><details id="https://www.notion.so/73f3d2269d074b25923b5b140a7558cc" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/118c02603d5445c18658eff3a68881a9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 reconnect...                                                                                                                                                
                                                                                                           S2 recv command, LENLOG: 6, T: 1                    
                                                                                                           S2 send to S1, ENTRIES: [{106 1 6}]                 
                                                                                                           S2 send to S0, ENTRIES: [{102 1 2} {103 1 3} {104 1 
                                                                                                           4} {105 1 5} {106 1 6}]                             
                                                      S1 recv append from S2, T: 1, ENTRIES: [{106 1 6}]                                                       
                                                      S1 -&gt; S2 append ok T: 1, LENLOG: 7                                                                       
S0 recv append from S2, T: 1, ENTRIES: [{102 1 2}                                                                                                              
{103 1 3} {104 1 4} {105 1 5} {106 1 6}]                                                                                                                       
S0 append fail, T: 6 large term                                                                                                                                
                                                                                                           S2 -&gt; S1 T: 1, send {PLI: 5, PLT: 1, CI: 5,         
                                                                                                           BEGINLOGIDX: 6, ENDLOGIDX: 6, LOG: [{106 1 6}]}     
                                                                                                           S2 update commitIndex CI: 6                         
                                                                                                           S2 apply msg: {true 106 6 false [] 0 0}             
                                                                                                           S2 -&gt; S0 T: 1, send {PLI: 1, PLT: 1, CI: 5,         
                                                                                                           BEGINLOGIDX: 2, ENDLOGIDX: 6, LOG: [{102 1 2} {103 1
                                                                                                           3} {104 1 4} {105 1 5} {106 1 6}]}                  
                                                                                                           S2 convert to candidate, calling election T: 6      
                                                      S1 C6 ask for vote, T: 7                                                                                 
S0 C6 ask for vote, T: 7                                                                                                                                       
                                                      S1 -&gt; S2 vote true, from T: 1 to CT: 7                                                                   
S0 -&gt; S2 vote true, from T: 6 to CT: 7                                                                                                                         
                                                                                                           S2 convert to leader at T: 7                        
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                      S1 apply msg: {true 106 6 false [] 0 0}                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 6                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 5                     
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 4                     
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, fail send {PLI: 1, PLT: 1, CI: 4}    
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 3                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 2                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 -&gt; S2 recv heartbeat                                                                                                                                        
S0 apply msg: {true 101 1 false [] 0 0}                                                                                                                        
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, fail send {PLI: 1, PLT: 1, CI: 3}    
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 -&gt; S2 recv heartbeat                                                                                                                                        
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat</span></span></span></code></pre></div></details><details id="https://www.notion.so/c7280862fa9f4d91bf3e19f76ec4ee7e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/f2b1f2601dd94250b2cc3c693215eb09" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">只要leaderCommit比自己的commitId要大，就会信号提示applyMsg。</span></span></li><li id="https://www.notion.so/cd24ba08a13742bd88bbb213fd9999bb" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">重联后会重新选举Leader，也就是说重新选出的Leader会重新初始化自己的nextIndex。自然的，第一次尝试对重联的Server进行append会因为没有匹配的index而被拒绝，于是寄了。</span></span></li></ol></div></details><details id="https://www.notion.so/8627a1a79d04419ea97d4f2a1a29a760" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/cba70ab2c56c4573bebf9866c12c0788" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">不再对heartbeat特殊对待，也就是说heartbeat和broadcast争抢对Server的更新</span></span></li></ol><div id="https://www.notion.so/bac3530026e84724af93be2b5123e6e0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></div></details><div id="https://www.notion.so/c62ccd03b3274e23a8f584e98523ff4d" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Apply massage的时候出现了顺序出错的问题</span></span></del></div></div></div><details id="https://www.notion.so/c60ca3ca7e8c4b619d9544b93bf49807" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/20fcb1fbca204da9a71d7b636a7fe50a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>// log
S0 commitIndex: 6                                                                                                                                                    
S0 -&gt; S2 append ok T: 9, LENLOG: 7                                                                                                                                   
                                                                                                               S2 -&gt; S1 T: 9, send heartbeat                         
                                                                                                               S2 -&gt; S1 update success, NEXT: [1 7 7], MATCH: [0 6 0]
                                                                                                               S2 get N: 6                                           
S0 apply msg: {true 106 6 false [] 0 0}                                                                                                                              
S0 ######## CI: 6, cfg.log: [map[0:init server 1:101]                                                                                                                
map[0:init server 1:101 2:102 3:103 4:104 5:105 6:106]                                                                                                               
map[0:init server 1:101 2:102 3:103 4:104 5:105 6:106]]                                                                                 S2 -&gt; S0 T: 7, send heartbeat


// related code
func (cfg *config) checkLogs(i int, m ApplyMsg) (string, bool) {
	err_msg := &quot;&quot;
	v := m.Command
	for j := 0; j &lt; len(cfg.logs); j++ {
		if old, oldok := cfg.logs[j][m.CommandIndex]; oldok &amp;&amp; old != v {
			log.Printf(&quot;%v: log %v; server %v\n&quot;, i, cfg.logs[i], cfg.logs[j])
			// some server has already committed a different value for this entry!
			err_msg = fmt.Sprintf(&quot;commit index=%v server=%v %v != server=%v %v&quot;,
				m.CommandIndex, i, m.Command, j, old)
		}
	}

	DebugLog(dDrop, &quot;S%d ######## CI: %d, cfg.log: %v\n&quot;, i, m.CommandIndex, cfg.logs)
	_, prevok := cfg.logs[i][m.CommandIndex-1]
	cfg.logs[i][m.CommandIndex] = v
	if m.CommandIndex &gt; cfg.maxIndex {
		cfg.maxIndex = m.CommandIndex
	}
	return err_msg, prevok
}</span></span></span></code></pre></div></details><details id="https://www.notion.so/4583313e4c014c588818cd210176fd63" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/fc1869b0b3744410a60b5d2c91eb1dad" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">首先，chan是一个fifo。这里会根据fifo中吐出的ApplyMsg进行判断，将ApplyMsg中的信息提取并储存在cfg.log中。Server重联后，仅放入最新的ApplyMsg会导致index out of range的问题。</span></span></li></ol></div></details><details id="https://www.notion.so/6580f888b1ea4643a0c57622c45034aa" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/462c48c100b7482ba7cf0ccba1bbf19c" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">也就是说，需要按照顺序往chan里一个一个放入ApplyMsg而不是仅放入最新的ApplyMsg。</span></span></li></ol></div></details><div id="https://www.notion.so/8c055772c67a4807bc3ad388bb474e55" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/404240dd19bc41839cc8656894095f5b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>➜ go test -run 2B   
Test (2B): basic agreement ...
  ... Passed --   0.5  3   16    4290    3
Test (2B): RPC byte count ...
  ... Passed --   1.3  3   48  113614   11
Test (2B): agreement after follower reconnects ...
  ... Passed --   5.3  3  192   50800    8
Test (2B): no agreement if too many followers disconnect ...
  ... Passed --   3.4  5  264   51340    3
Test (2B): concurrent Start()s ...
  ... Passed --   0.6  3   24    6790    6
Test (2B): rejoin of partitioned leader ...
  ... Passed --   3.9  3  146   35480    4
Test (2B): leader backs up quickly over incorrect follower logs ...
  ... Passed --  14.0  5 2244 1728755  102
Test (2B): RPC counts aren&#x27;t too high ...
  ... Passed --   2.0  3   62   18665   12
PASS
ok      6.824/raft      31.039s</span></span></span></code></pre></div></div><h3 id="https://www.notion.so/05451af5101c4742901e74a89a9773e5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/05451af5101c4742901e74a89a9773e5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2C</span></span></h3><div id="https://www.notion.so/3647952aea0149e3bf7d90357850ace1" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">一运行到unrealiable的test就出现out of index的错误，现在想来好像在</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2B</strong></span><span class="SemanticString">中偶尔也会出现这个错误，还债了属于是。</span></span></del></div></div></div><details id="https://www.notion.so/afe0b15e036f4360b998ea33e625da4e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/d5137da7c2c2438999204f5bcea51cd9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>➜ go test -run UnreliableChurn
Test (2C): unreliable churn ...
panic: runtime error: index out of range [8] with length 8

goroutine 22 [running]:
6.824/raft.(*Raft).Apply(0xc0001b2000)
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:596 +0x214
created by 6.824/raft.Make
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:757 +0x3d6
exit status 2
FAIL    6.824/raft      0.300s</span></span></span></code></pre></div></details><details id="https://www.notion.so/9a039b4173e141769619a195ea754929" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/66c53012b2f14f978c3da2565ae695b8" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">很奇怪，有时可以通过，有时不行，2C中的Unreliable测试放大了系统的弱点，可以确定的是，心跳间隔的设置和这个错误是有关的。后来发现原来是因为延迟，Follower接受了Index更古老的消息，并覆盖了新的消息。</span></span><pre id="https://www.notion.so/fb79b3cdd9f34064a6bb45b455c7b168" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 reconnect...                                                                                                                                  
                              S1 reconnect...                                                                                                    
                                                           S2 reconnect...                                                                       
                                                                                        S3 reconnect...                                          
                                                                                        S3 -&gt; S4 append ok T: 26,                                
                                                                                        LENLOG: 207                                              
                                                                                                                     S4 -&gt; S2 LogInfo {IDX: 192, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 192,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S2, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                                                     S4 -&gt; S3 update success,    
                                                                                                                     NEXT: [193 205 193 207 193],
                                                                                                                     MATCH: [0 204 0 206 0]      
                                                                                                                     S4 get N: 204               
                                                                                                                     S4, LENLOG: 207, LA: 204    
                                                                                                                     apply msg {CI: 205}         
                                                                                                                     S4 -&gt; S3 LogInfo {IDX: 206, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 206,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S3, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                              S1 -&gt; S4 append ok T: 26,                                                                                          
                              LENLOG: 207                                                                                                        
                                                           S2 append fail, T: 27 large                                                           
                                                           term                                                                                  
                                                                                                                     S4 -&gt; S1 update success,    
                                                                                                                     NEXT: [193 207 193 207 193],
                                                                                                                     MATCH: [0 206 0 206 0]      
                                                                                                                     S4 get N: 206               
                                                                                                                     S4 update commitIndex CI:   
                                                                                                                     206                         
                                                                                                                     S4, LENLOG: 207, LA: 205    
                                                                                                                     apply msg {CI: 206}         
                                                                                                                     S4 -&gt; S2 LogInfo {IDX: 192, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 192,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S2, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                        S3 commit {CI: 205, LENLOG:                              
                                                                                        207}                                                     
                                                           S2 append fail, T: 27 large                                                           
                                                           term                                                                                  
                                                                                                                     S4 reconnect...             
                              S1 -&gt; S4 append ok T: 26,                                                                                          
                              LENLOG: 206                                                                                                        
                                                                                                                     S4 -&gt; S1 LogInfo {IDX: 206, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 206,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S1, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                        S3 -&gt; S4 append ok T: 26,                                
                                                                                        LENLOG: 205</span></span></span></code></pre></li><li id="https://www.notion.so/81d2c6930a524498beac28c6da665860" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">有时候会出现索引取到-1的情况，排查出是append时条件设置有误。此外，当一个Server detach以后，会持续向别的server发送信息，不断收到fail update，自然会不断减小nextIndex的值。直到nextIndex变为0,自减后变为-1,索引越界。</span></span></li></ol></div></details><details id="https://www.notion.so/0b4c5a92b41342209bd380bc7e172c16" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/99972ea87afb401ca01665d03db6cbd9" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">修改条目更新的规则，遵循VoteRequest RPCs中的up-to-date原则。</span></span><pre id="https://www.notion.so/7c21d5951b8145ebbf990c0114d046c9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if len(args.Entries) == 0 {
	DebugLog(dLog, &quot;S%d -&gt; S%d recv heartbeat\n&quot;, rf.me, args.LeaderId, rf.currTerm, len(rf.logEntries))
} else {
	rfLastLogIndex, rfLastLogTerm := rf.LogInfoByIndex(len(rf.logEntries) - 1)
	argLastLogIndex, argLastLogTerm := args.Entries[len(args.Entries)-1].Index, args.Entries[len(args.Entries)-1].Term
	if rfLastLogTerm &lt; argLastLogTerm || (rfLastLogTerm == argLastLogTerm &amp;&amp; rfLastLogIndex &lt; argLastLogIndex) {
		rf.logEntries = rf.logEntries[:args.PrevLogIndex+1]
		rf.logEntries = append(rf.logEntries, args.Entries...) // persist
		rf.persist()
	}

	DebugLog(dLog2, &quot;S%d -&gt; S%d append ok T: %d, LENLOG: %d\n&quot;, rf.me, args.LeaderId, rf.currTerm, len(rf.logEntries))
}</span></span></span></code></pre><div id="https://www.notion.so/04b147afe6104a02a7ab9ff6c5d5a8e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">同时要注意修改reply处理部分的代码，不然会将nextIndex和matchIndex更新成旧的索引。</span></span></p></div><pre id="https://www.notion.so/4b123569fe2b4e3f92be0aa94bb29ee5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if reply.Success {
	if rf.nextIndex[id] &lt; endOfIndex {
		rf.nextIndex[id] = endOfIndex
		rf.matchIndex[id] = endOfIndex - 1
		DebugLog(dError, &quot;S%d -&gt; S%d update success, NEXT: %v, MATCH: %v\n&quot;, rf.me, id, rf.nextIndex, rf.matchIndex)
		go rf.updateCommitIndex()
	}
	// 讲道理，更新成功就要试试能不能update commitIndex
} else {
	rf.nextIndex[id] /= 2
	DebugLog(dError, &quot;S%d -&gt; S%d update failed, NEXT: %d\n&quot;, rf.me, id, rf.nextIndex[id])
}</span></span></span></code></pre></li><li id="https://www.notion.so/9e885df2c0c04a71b0506b8e60deb64a" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">贴出错误代码</span></span><pre id="https://www.notion.so/fb0384cd51744f36862384c25db6ae9e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike"><span>if args.PrevLogIndex &gt;= len(rf.logEntries) || rf.logEntries[args.PrevLogIndex].Term != args.PrevLogTerm {
</span></del></span><span class="SemanticString"><span>if args.PrevLogIndex &gt; len(rf.logEntries)-1 || rf.logEntries[args.PrevLogIndex].Term != args.PrevLogTerm {
	reply.Success = false
	DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
	return
}</span></span></span></code></pre><div id="https://www.notion.so/5ca86251dda544a2b2882879468df96b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此外，打了个补丁，让nextIndex等于max(1, nextIndex/2)，不知道这个补丁可不可以美化。</span></span></p></div></li></ol></div></details><div id="https://www.notion.so/ea7202ad94cd4f2f87f03ce958c46f26" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">有极小的概率出现问题：ApplyMsg顺序错位。</span></span></del></div></div></div><details id="https://www.notion.so/e99263c4bfbd45dbb85bbc66afd3b697" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/137b7a2389d34ee9b8ab32ae0f90d231" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2C): Figure 8 (unreliable) ...
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
apply error: commit index=52 server=3 2540 != server=4 9070</span></span></span></code></pre></div></details><details id="https://www.notion.so/8b37dc82794549d3a6f2235a71c48210" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/aabfb220e26b47fca32781b478e64a81" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">没排查出来</span></span></li></ol></div></details><details id="https://www.notion.so/2609d0476661499a9034430f9c26ce21" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/432e6467f6fd42da965676abed4808ef" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">将AppendEntries中的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">defer rf.applyCh.Signal()</code></span><span class="SemanticString"> 变成了 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rf.applyCh.Signal()</code></span></span></li></ol></div></details><div id="https://www.notion.so/e151de3aedca4fc28718626205986bd8" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/560d76947c4a4e3381268ea767dce5bd" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>➜ go test -run 2C                                               
Test (2C): basic persistence ...
  ... Passed --   3.1  3   78   18954    6
Test (2C): more persistence ...
  ... Passed --  14.4  5 1036  200240   16
Test (2C): partitioned leader and one follower crash, leader restarts ...
  ... Passed --   1.3  3   36    8539    4
Test (2C): Figure 8 ...
  ... Passed --  27.0  5 1180  256006   58
Test (2C): unreliable agreement ...
  ... Passed --   1.7  5 1048  345471  246
Test (2C): Figure 8 (unreliable) ...
  ... Passed --  33.6  5 19228 18476272  138
Test (2C): churn ...
  ... Passed --  16.4  5 6992 9763562 1432
Test (2C): unreliable churn ...
  ... Passed --  16.1  5 4236 5664994  384
PASS
ok      6.824/raft      113.623s</span></span></span></code></pre></div></div><h3 id="https://www.notion.so/d6b18336cd85414987d8d4c31bc3a38a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d6b18336cd85414987d8d4c31bc3a38a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2D</span></span></h3><blockquote id="https://www.notion.so/5589b63c074041c48210baf106a6f250" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">在2D中，很重要的一点是，切片底层是数组实现，如果想要让GC reach到被snapshot掉的无用内存，就需要重新创建切片，原切片指针置空。</span></span></blockquote><div id="https://www.notion.so/95f9b1f44b3541158e10483066ca958f" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">有概率出现问题：在更新commitIndex的时候出现out of Index问题。</span></span></del></div></div></div><details id="https://www.notion.so/f5e4c3bd2a7b4b81a49b2e3f736dd940" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/da53c7bc194e42d496400af4e5ddd737" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2C): unreliable churn ...
panic: runtime error: index out of range [1656] with length 1656

goroutine 106315 [running]:
6.824/raft.(*Raft).updateCommitIndex(0xc000136200)
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:647 +0x345
created by 6.824/raft.(*Raft).broadcastAppendEntries.func1
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:622 +0x796
exit status 2</span></span></span></code></pre></div></details><details id="https://www.notion.so/562370472eb546c49822138d6ff25cdd" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/ef1ccf8d2d04422c941e2eb274e58871" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">updateCommitIndex函数原本是使用协程实现的，所以有极小的概率，在updateCommitIndex之前，完成了Leader转换、重新广播、更新新的CommitIndex这一系列操作。使得一开始的更新协程出现越界。</span></span></li></ol></div></details><details id="https://www.notion.so/db8374742dc14769a38ffd5b2caf63ac" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c7f0bd646114432ab6eee0279fe02b29" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">线性执行updateCommitIndex，去除函数中的加锁操作，统一由主协程管理锁</span></span><pre id="https://www.notion.so/afb6d7e565d540dcb6b09d63d685af36" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>func (rf *Raft) updateCommitIndex() {
	// rf.mu.Lock()
	// defer rf.mu.Unlock()

	var dupMatchIndex []int
	dupMatchIndex = append(dupMatchIndex, rf.matchIndex...)
	dupMatchIndex[rf.me] = rf.logEntries[len(rf.logEntries)-1].Index
	sort.Ints(dupMatchIndex)
	DebugLog(dError, &quot;S%d get N: %d\n&quot;, rf.me, dupMatchIndex[(len(rf.peers)-1)/2])

	var N int = dupMatchIndex[(len(rf.peers)-1)/2]
	if N &gt; rf.commitIndex &amp;&amp; rf.logEntries[N].Term == rf.currTerm {
		rf.commitIndex = N
		defer rf.applyCond.Signal()
		DebugLog(dError, &quot;S%d update commitIndex CI: %d\n&quot;, rf.me, rf.commitIndex)
	}
}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/2aff85104af44f4aa996aec6b9861a78" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">死锁问题：一开始执行Snapshot函数就卡在获得锁的操作这里。</span></span></del></div></div></div><details id="https://www.notion.so/c6351b11e39f42e7bf5af5d67da0bab5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/7606240c69314cc780f0454c4eb87540" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 -&gt; S1 append ok T: 1,                                                      
                                                      LENLOG: 14                                                                    
                            S1 start create snapshot                                                                                
                            LII: 9, T: 1                                                                                            
                            S1 start create snapshot,                                                                               
                            before lock                                                                                             
                            S1, LENLOG: 14, LA: 1                                                                                   
                            apply msg {CI: 10}                                                                                      
S0 convert to candidate,                                                                                                            
calling election T: 1                                                                                                               
S0 LogInfo {IDX: 1, LENLOG:                                                                                                         
2, LOG:                                                                                                                             
{7859782014890577642 1 1}}                                                                                                          
                                                      S2 C1 ask for vote, T: 2                                                      
                            S1 C1 ask for vote, T: 2                                                                                
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 -&gt; S0 vote false, old                                                      
                                                      log                                                                           
                                                      S2 convert to candidate,                                                      
                                                      calling election T: 2                                                         
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                            S1 C1 ask for vote, T: 3                                                                                
S0 C1 ask for vote, T: 3                                                                                                            
S0 LogInfo {IDX: 1, LENLOG:                                                                                                         
2, LOG:                                                                                                                             
{7859782014890577642 1 1}}                                                                                                          
S0 -&gt; S2 vote true, from T:                                                                                                         
2 to CT: 3                                                                                                                          
                                                      S2 convert to leader at                                                       
                                                      T: 3                                                                          
                                                      S2 -&gt; S1 LogInfo {IDX:                                                        
                                                      13, LENLOG: 14, LOG:                                                          
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}</span></span></span></code></pre></div></details><details id="https://www.notion.so/94e543bf67554d4e926e0122791273d3" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/a2f0bf183dd64e4480afd3c3393c340f" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">快照的间隔是每10条command进行一次快照，因此节点在进行将已经提交了的指令发送到applyCh进行执行的时候不能获取有rf.mu这个互斥锁，因为在你提交指令并将该指令发送到applyCh执行的同时，测试脚本会调用Snapshot函数进行快照，但是我设计的这个函数也需要获取rf.mu互斥锁，那么这个节点就会进入死锁状态：无法获取rf.mu互斥锁进行快照，另一边是需要等快照结束才能继续提交指令并执行，以及后续动作。</span></span></li></ol></div></details><details id="https://www.notion.so/9b67e71561714b68bc9fe05ba672ceb1" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/2da389e00f714bcb9368e274c78d24a5" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在Apply函数中进行如下修改</span></span><pre id="https://www.notion.so/1383e8795f5643e5a9e491a2d174cffb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	++	rf.mu.Unlock()
			rf.applyCh &lt;- msg
	++	rf.mu.Lock()</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/ab228a28a23a4b8cbbdf370ad5a4494d" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">AppendEntries中出现负数的Log索引</span></span></del></div></div></div><details id="https://www.notion.so/41348277d92a4fc899b6bf2f00d1705d" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/9c92c9e947dc4f1aa655b8ab608a1ab2" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">原来只需要检查args.PrevLogIndex小于等于Log最后一项的索引值。但是在引入snapshot后还需要检查args.PrevLogIndex大于等于lastIncludedIndex，因为历史的AppendEntries RPC可以延迟抵达</span></span><pre id="https://www.notion.so/1968a9a46b484f90860ea684086796c8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.PrevLogIndex &gt; rf.logEntries[len(rf.logEntries)-1].Index ||
		rf.logEntries[args.PrevLogIndex-rf.snapshot.LastIncludedIndex].Term != args.PrevLogTerm { // ATTENTION 这里可能会越界，要减去lastincludedindex
		reply.Success = false
		DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/965b8981adbf4d3ab0ed424967c6a409" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/b88fb5a5ef144feeb82c5b46418466a8" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在这种情况下，可以直接将reply的success置true并返回，因为对于成功时返回值的处理已经考虑到了延迟消息（2C）</span></span><pre id="https://www.notion.so/3deabfd4394e4149be70aacca665fd46" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if rf.snapshot.LastIncludedIndex &gt; args.PrevLogIndex {
		reply.Success = true
		DebugLog(dVote, &quot;S%d append success, snapshot interrupt...\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/0f1d3ca89b3c4dcfa4f6742c18f11454" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">broadcast中出现负数的Log索引</span></span></del></div></div></div><details id="https://www.notion.so/0f7f8d104ba64ea198b7e85c809b0d9a" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/b47b1fcd85ff499fb9794c1dc1d8ada4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">nextIndex[0] == snapshot.lastIncludedIndex</span></span></p></div><pre id="https://www.notion.so/bba27868dc174b66b403611f833e1055" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S1 -&gt; S0 LogInfo {IDX: 108,                                                                                                 
                                 LENLOG: 8, LOG:                                                                                                             
                                 {5178380306894727311 1 116}},                                                                                               
                                 NEXT: [109 1 117], SS: {109 1}                                                                                              
                                                                S2, LENLOG: 18, LA: 108 apply                                                                
                                                                msg {CI: 109}                                                                                
                                                                S2, LENLOG: 18, LA: 108 apply                                                                
                                                                msg {CI: 110}                                                                                
                                                                S2 -&gt; S1 recv heartbeat

#################################################
panic: runtime error: index out of range [-1]

goroutine 890 [running]:
6.824/raft.(*Raft).LogInfoByIndex(0xc000134100, 0xffffffffffffffff)
	/home/humborn/Code/go/MIT-6.5840/src/raft/util.go:101 +0xbd
6.824/raft.(*Raft).broadcastAppendEntries.func1(0x0)
	/home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:716 +0x84c
created by 6.824/raft.(*Raft).broadcastAppendEntries
	/home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:669 +0x15f
exit status 2</span></span></span></code></pre></div></details><details id="https://www.notion.so/f173495d21304cd9b3d005e60363aac0" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/6b4afbd6e3cb4220b1cc1a7075b3909a" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">同样的，广播发布了协程后并未立即执行，而snapshot在协程运行之前更新了lastIncludedIndex。仔细观察可以发现出错的Log的索引都是mod 10余9的，对应了snapshot的生成规律，验证了猜想。</span></span><pre id="https://www.notion.so/212a3a5e7378442597d8723354e2d06a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.PrevLogIndex &gt; rf.logEntries[len(rf.logEntries)-1].Index ||
		rf.logEntries[args.PrevLogIndex-rf.snapshot.LastIncludedIndex].Term != args.PrevLogTerm { // ATTENTION 这里可能会越界，要减去lastincludedindex
		reply.Success = false
		DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/4b1b4e3d574f4565a1f4c238def4459c" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c785b68d6153414fb0ddb67d76ff11c9" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">将广播条件中触发快照加载的条件由 &lt; 改为 ≤ 。</span></span><pre id="https://www.notion.so/71f94e194c2d4e1fa2175662bea7870e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>go func(id int) {
			rf.mu.Lock()
			// 需要注意的是，当rf.nextIndex[id] == rf.logEntries[len(rf.logEntries)-1].Index+1，对应的是发送heartbeat的情况
			if rf.nextIndex[id] &gt; rf.logEntries[len(rf.logEntries)-1].Index+1 {
				rf.mu.Unlock()
				return
			}

			</span></span><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike"><span>if rf.nextIndex[id] &lt; rf.snapshot.LastIncludedIndex {</span></del></span><span class="SemanticString"><span>
			if rf.nextIndex[id] &lt;= rf.snapshot.LastIncludedIndex {</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/ed69e00ab7e84147803a910ddbbf1bf2" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">ApplyMsg顺序错位第二弹，详循2C中的第二个问题</span></span></del></div></div></div><details id="https://www.notion.so/346986e92c574b8d94e05c0fb45903d5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/0e0903f4554e4191913ae6aaf611fe2e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2D): snapshots basic ...
apply error: server 0 apply out of order, expected index 100, got 101
exit status 1
FAIL    6.824/raft      1.269s</span></span></span></code></pre></div></details><details id="https://www.notion.so/65bc8a7576bd47f5917652fba20a12f4" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/db81ee707f004a749266285eb4537f26" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在原来的Apply实现中，循环中的cid只被初始化了一次，但是在这里，每次循环中会随插入记录的数量增加生成snapshot，改变原来的初始值。</span></span><pre id="https://www.notion.so/9e46f2307361424382c22d1f90f000d7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>		for cid := max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1; cid &lt;= rf.commitIndex; cid++ {
			DebugLog(dError, &quot;S%d, LENLOG: %d, LA: %d apply msg {CI: %d} \n&quot;, rf.me, len(rf.logEntries), rf.lastApplied, cid)
			msg := ApplyMsg{
				CommandValid: true,
				Command:      rf.logEntries[cid-rf.snapshot.LastIncludedIndex].Command,
				CommandIndex: cid,
			}
			rf.mu.Unlock()
			rf.applyCh &lt;- msg
			rf.mu.Lock()
		}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/292517fd444f43e4890dc0b03f8f6761" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/8bdb5d53c98b43e7be78f135c301ec84" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">多次初始化。</span></span><pre id="https://www.notion.so/e9b0c164c0274b47a63fd4ba73dc74ac" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>		cid := max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1
		for cid &lt;= rf.commitIndex {
			DebugLog(dError, &quot;S%d, LENLOG: %d, LA: %d apply msg {CI: %d} \n&quot;,
				rf.me, len(rf.logEntries), rf.lastApplied, cid)
			msg := ApplyMsg{
				CommandValid: true,
				Command:      rf.logEntries[cid-rf.snapshot.LastIncludedIndex].Command,
				CommandIndex: cid,
			}
			rf.mu.Unlock()
			rf.applyCh &lt;- msg
			rf.mu.Lock()
			rf.lastApplied = cid
			cid = max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1
		}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/ddb596c63df34d50911b7087d4123bdb" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">首先，可以知道，apply out of order有两种形态，一种是接收到了有延迟的信息，还有一种是接收到了未来的信息。以InstallSnapshot RPC为例，可以通过下面这段代码对延迟信息进行过滤。但是raft的Term、commitIndex和lastApplied等索引都是完备的，讲道理不会出现“未来的”信息。</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/0747c3557cd3426f88e4f0abbad28258" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if rf.commitIndex &lt; args.LastIncludedIndex {
		rf.commitIndex = args.LastIncludedIndex
	}
	if rf.lastApplied &lt; args.LastIncludedIndex {
		rf.lastApplied = args.LastIncludedIndex
	}</span></span></span></code></pre></div></div><details id="https://www.notion.so/80cf80202f514866ad9abd52b47aa21f" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/b4681f42c68b465ab2404066f1c12fdb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>apply error: server 0 apply out of order, expected index 230, got 231
exit status 1
FAIL	6.824/raft	1.852s</span></span></span></code></pre></div></details><details id="https://www.notion.so/3be6fa27897647c2b44ca3b5a789a423" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/6165ef9bb861471b8a80a4222d34f7db" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在测试代码中，snapshot在ApplyCh中被接收后，会以自身的lastIncludedIndex刷新service server的对应参数，造成“版本回退”。</span></span></li></ol></div></details><details id="https://www.notion.so/40b2bbdf055440f398875a1beb905fe1" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c8fcc2e0a13f4aba8d760c1c47bafe99" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在InstallSnapshot中与lastApplied进行比较判断过滤“版本回退”</span></span><pre id="https://www.notion.so/d3e0ac863c0e454f990a4ceeecb19994" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.LastIncludedIndex &lt;= rf.snapshot.LastIncludedIndex ||
		args.LastIncludedIndex &lt;= rf.lastApplied {
		rf.mu.Unlock()
		return
	}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/3157b400c29d48dbaa74d293e9955892" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">会报莫名其妙的错误</span></span></del></div></div></div><details id="https://www.notion.so/95d0368d44d34e9eb79f09fbcb797451" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/935cd0740a5b4774a86b200526c90469" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">第一列的Index和LII不对应造成的</span></span></p></div><pre id="https://www.notion.so/31888519f9d149ada30de4f77f4a5597" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 ingestSnap: snapshot doesn&#x27;t match                                                                                                                    
m.SnapshotIndex, INDEX: 39, LII: 29                                                                                                                      
S0 C46 install snapshot, IDX: 39 T: 1,                                                                                                                   
start from 39 to 46                                                                                                                                      
#############################################################################

apply error: server 0 snapshot doesn&#x27;t match m.SnapshotIndex
exit status 1
FAIL	6.824/raft	1.041s</span></span></span></code></pre></div></details><details id="https://www.notion.so/f899c66e01f64474a15d0c72a2b4b481" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">排查出的问题</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/45dbf0d14b0047c1b67ef7890d6a2133" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">由于在前面的问题排查中已经基本解决了out of order的问题，推测出现这种情况的原因是SaveStateAndSnapshot函数存在先后执行顺序，协程有延迟，使得保存的时候没有起到拦截out of order的作用</span></span></li></ol></div></details><details id="https://www.notion.so/c799a34508a54eb5b48a188ca7ebc50c" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">方案</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/624d4322b29444b0b5804ffcfdcc0bd0" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">把所有的rf.mu.Lock()统统移到SaveStateAndSnapshot函数后面保证线性顺序。</span></span></li></ol></div></details><div id="https://www.notion.so/ccce9d2d1f34495f9ab239ef233c057e" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/7f9bf796bc0047d0bf5e355c57e7e551" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>➜ go test -run 2D              
Test (2D): snapshots basic ...
  ... Passed --   1.8  3  506  164008  235
Test (2D): install snapshots (disconnect) ...
  ... Passed --  32.9  3 2444 1245742  316
Test (2D): install snapshots (disconnect+unreliable) ...
  ... Passed --  38.7  3 3604 1300893  327
Test (2D): install snapshots (crash) ...
  ... Passed --  24.5  3 1148  879888  334
Test (2D): install snapshots (unreliable+crash) ...
  ... Passed --  33.0  3 1432  692990  322
Test (2D): crash and restart all servers ...
  ... Passed --   6.7  3  244   64312   54
PASS
ok      6.824/raft      137.622s</span></span></span></code></pre></div></div></article>
  <footer class="Footer">
  <div>&copy; 躺平仔乐园 2023</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>