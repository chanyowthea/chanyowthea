<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fb143553a-62bb-4561-8744-efc9017c43b0%2Fa7cee299-b32f-4387-a829-55965daa3299%2Fcat.jpg?table=collection&amp;id=a1b4dbf5-8bef-463d-bf08-b55c43072e4b">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>MIT 6.5840&nbsp;|&nbsp;èººå¹³ä»”ä¹å›­</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="MIT 6.5840">
  
    <meta name="description" content="MIT 6.5840 note">
    <meta property="og:description" content="MIT 6.5840 note">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;â•&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fb143553a-62bb-4561-8744-efc9017c43b0%2Fa7cee299-b32f-4387-a829-55965daa3299%2Fcat.jpg?table=collection&amp;id=a1b4dbf5-8bef-463d-bf08-b55c43072e4b"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸŒ–&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;â•&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">MIT 6.5840</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Apr 28, 2023</span>
        
        
      </div>
    
  </header>
  <article id="https://www.notion.so/ca570599ff8b4661a15d8086770b3630" class="PageRoot"><div id="https://www.notion.so/d47da8ac80da41838b4bda73cbc7fb85" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">ğŸ˜‡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">All I need to know about 6.5840
Full code on:
</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/humbornjo/MIT-6.5840">https://github.com/humbornjo/MIT-6.5840</a></span></span></p></div><h1 id="https://www.notion.so/26409dbfc310415e85fae4e4d2379924" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/26409dbfc310415e85fae4e4d2379924"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Lab1</span></span></h1><div id="https://www.notion.so/547211e6a0a64eca902d9952ffebc414" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">ğŸ’¡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">è™½ç„¶æœ¬æ¬¡å®éªŒæ²¡æœ‰è§¦åŠï¼Œä½†æ˜¯GFSæ‰æ˜¯Map Reduceçš„çµé­‚ã€‚è¿™ä¹Ÿæ˜¯å¾ˆå¤šMRæ–¹æ³•å±€é™åœ¨å•æœºè¿è¡Œçš„æ ¹æœ¬åŸå› ã€‚åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ä¸­ï¼Œintermediateçš„äº¤æ¢æ‰æ˜¯äº‹å®ä¸Šçš„é‡ç‚¹ã€‚</span></span></p></div><h2 id="https://www.notion.so/0bf9517b752a42de8875ae4366399f49" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0bf9517b752a42de8875ae4366399f49"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Difficulties &amp; solution</span></span></h2><details id="https://www.notion.so/9a0f47cc241d4c069844df9b08fc4762" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">coordinator ä½œä¸ºè°ƒåº¦è€…ï¼Œå°±ç®—å…¶å…ƒç´ éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¾ç„¶æ˜¯éœ€è¦åŠ ä¸€ä¸ªæ•´ä½“çš„é”çš„ã€‚ï¼ˆä»…é’ˆå¯¹æˆ‘çš„è®¾è®¡ä¸å®ç°ï¼‰</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/ba46b4c45e8e4db4a2ad3fab9e7b8029" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>type Coordinator struct {
	// Your definitions here.
	nMap     int
	nReduce  int
	stage    int
	currTask chan Task
	runnTask map[Task]chan int
	lock     sync.RWMutex
}</span></span></span></code></pre><div id="https://www.notion.so/fc7bd60083ae4c9d978c823a9cb823f2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨æˆ‘çš„å®ç°ä¸­ï¼Œå½“currTaskå’ŒrunnTaskå…¨ä¸ºç©ºæ—¶æ–¹å¯è§¦å‘stageçš„è½¬æ¢ï¼ˆæ¯”å¦‚ä»MAPè½¬ç§»åˆ°REDUCEï¼‰ã€‚å¦‚æœåˆ†åˆ«åŠ é”ï¼Œå°±å¯èƒ½å¯¼è‡´ â†’ </span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/fd8dee5496334dec8143b1ea959d0250" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æ£€æŸ¥currTaskæ—¶ä¸ºç©º</span></span></li><li id="https://www.notion.so/7f91de613fcb422ea639ae2dd1d15422" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">runnTaskè¶…æ—¶ï¼Œåˆ é™¤ä»»åŠ¡ï¼Œæœªå®Œæˆçš„ä»»åŠ¡é‡æ–°å…¥é˜ŸcurrTask</span></span></li><li id="https://www.notion.so/ea00b790f082401784cb108f508819a9" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">æ£€æŸ¥runnTaskï¼Œä¹Ÿä¸ºç©º</span></span></li><li id="https://www.notion.so/5f5fda101a1f412ba4e9cb9d1bf8d408" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">çŠ¶æ€è½¬æ¢äº†ï¼ŒMRå¤±è´¥</span></span></li></ol></div></details><details id="https://www.notion.so/ff712cf2b26e43f9b4ae689c93a1d2e2" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">rpcçš„è®¾è®¡ä¸ç»†èŠ‚</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/9aa497843ccb4ffc97dcf4a0b04292e8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/*
type Task struct {
	Tid   int
	Fname string
}
*/

type AskForTaskArgs struct {
	Wid int
}

type AskForTaskReply struct {
	Stage int
	Task  Task
	Nout  int
}

type ReportForTaskArgs struct {
	Task Task
}

type ReportForTaskReply struct {
	Foo bool
}</span></span></span></code></pre><div id="https://www.notion.so/91a5ebeea75e435f8556433ba5df6608" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ€»ä½“åˆ†ä¸ºAskå’ŒReportä¸¤ç§ï¼Œä¸»è¦çš„é—®é¢˜åœ¨äºReport RPCå‰åä¸´æ—¶æ–‡ä»¶çš„ä¿å­˜å’ŒçŠ¶æ€çš„è½¬å˜ï¼Œä¸‹é¢è¿›è¡Œåˆ†ç±»åˆ†æã€‚</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/4d90332e2add4d9aa24690d5f5ac98e3" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">MAPé˜¶æ®µçš„Report,æ˜¯åœ¨RPCè·å¾—trueçš„å›å¤åè¿›è¡Œä¿å­˜ä¸´æ—¶æ–‡ä»¶ï¼Œè¿˜æ˜¯å…ˆä¿å­˜ä¸´æ—¶æ–‡ä»¶ï¼Œå†call RPCã€‚</span></span><ol class="NumberedListWrapper"><li id="https://www.notion.so/a9b2d0f84ce04f1b9cf0610658f66a8a" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¦‚æœåœ¨è·å¾—RPCå›å¤åå†ä¿å­˜ã€‚å¦‚æœRPCç»“æœä¸ºtrueï¼ˆåœ¨æˆ‘çš„å®ç°ä¸­ï¼Œæ˜¯</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">reply.Foo == true</code></span><span class="SemanticString">ï¼‰ã€‚ä¼šå‡ºç°ä¸€ä¸ªææ€–çš„äº‹ï¼Œé‚£å°±æ˜¯coordinatorå·²ç»è½¬æ¢çŠ¶æ€äº†ã€‚å¼€å§‹åˆ†å‘REDUCEçš„ä»»åŠ¡äº†ï¼Œä½†æ˜¯MAPé˜¶æ®µçš„intermediateæ–‡ä»¶è¿˜æ²¡æœ‰ä¿å­˜å®Œã€‚è¿™å°±ä¼šå¯¼è‡´ï¼Œå¦‚æœæœ‰ä¸€ä¸ªWorkeræ­¤æ—¶æ°å¥½æ¥äº†ä»»åŠ¡ï¼Œå¹¶ç«äº‰è¿è¡Œäº†ï¼Œç„¶è€Œç›®æ ‡æ–‡ä»¶ç”šè‡³ä¸å­˜åœ¨ï¼Œæœ€ç»ˆREDUCEçš„ä»»åŠ¡ç»“æœå‡ºé”™ã€‚å¦‚æœRPCç»“æœä¸ºfalseï¼Œå½±å“ä¸å¤§ï¼Œå°±ç®—ä¿å­˜äº†ä¹Ÿä¼šè¢«å¦ä¸€ä¸ªWorkerçš„æ–‡ä»¶å†™å…¥æ›¿æ¢ã€‚</span></span></li><li id="https://www.notion.so/c5799c68b4e64377ae3447734a929da8" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">å¦‚æœåœ¨è·å¾—RPCå›å¤å‰å†ä¿å­˜ã€‚å¦‚æœRPCç»“æœä¸ºtrueï¼Œä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼Œè§£å†³äº†ä¸Šæ–¹çš„é—®é¢˜ã€‚å¦‚æœRPCç»“æœä¸ºfalseï¼Œå½±å“ä¸å¤§ï¼Œå°±ç®—ä¿å­˜äº†ä¹Ÿä¼šè¢«å¦ä¸€ä¸ªWorkerçš„æ–‡ä»¶å†™å…¥æ›¿æ¢ã€‚</span></span></li><li id="https://www.notion.so/167b910ef7a14c6cbda52cf9797c850c" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">ç»¼ä¸Šï¼Œé€‰æ‹©åœ¨RPCå›å¤å‰ä¿å­˜ã€‚</span></span></li></ol></li><li id="https://www.notion.so/9077c348f2b5479b8a8636d372cf2e37" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Reduceé˜¶æ®µçš„Reportï¼Œæ²¡å•¥å¥½è¯´çš„ï¼Œä¿å­˜å¿…ç„¶æ˜¯åœ¨RPCä¹‹å‰çš„ï¼Œå› ä¸ºå®ç°borrowäº†mrsequentialçš„ä»£ç ï¼Œç›®å‰æ¥çœ‹ï¼Œæ¢æˆåœ¨RPCä¹‹åé˜»å¡åœ°ä¿å­˜ï¼Œå”¯ä¸€çš„é£é™©å°±æ˜¯Workerçš„ä¸´æ—¶å®•æœºã€‚ï¼ˆæœ€åä¸è¦å¿˜äº†åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼‰</span></span><pre id="https://www.notion.so/25aa635c2ae74ffdb8e1ae7290f6567d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if !ReportForTask(
	&amp;ReportForTaskArgs{Task: reply.Task}, 
	&amp;ReportForTaskReply{}) {
	os.Remove(oname)
} else {
	for _, filename := range filenames {
		os.Remove(filename)
	}
}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/18ad3f1ff97649e3815aa554ef161e9d" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/511ee97ec3d2446b9fdd13a5fc9bd967" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>MIT-6.5840/src/main via ğŸ¹ v1.20.6 
<span class="token operator">></span> <span class="token function">bash</span> test-mr.sh
*** Starting <span class="token function">wc</span> test.
--- <span class="token function">wc</span> test: PASS
*** Starting indexer test.
--- indexer test: PASS
*** Starting map parallelism test.
--- map parallelism test: PASS
*** Starting reduce parallelism test.
--- reduce parallelism test: PASS
*** Starting job count test.
--- job count test: PASS
*** Starting early <span class="token builtin class-name">exit</span> test.
--- early <span class="token builtin class-name">exit</span> test: PASS
*** Starting crash test.
--- crash test: PASS
*** PASSED ALL TESTS</span></span></span></code></pre></div></div><h1 id="https://www.notion.so/29a16d4cf2ec45dc8ed0e1bb6a711ed7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/29a16d4cf2ec45dc8ed0e1bb6a711ed7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Lab2</span></span></h1><div id="https://www.notion.so/b607df8a45b9429fb732810220e27468" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">ğŸ’¡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">What u deserve to understand is that, even raft can make mistake. When the delay is high and command flood in.</span></span></p></div><h2 id="https://www.notion.so/6fa392768d0e400fb248a89454ea345e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6fa392768d0e400fb248a89454ea345e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Core Idea</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/09d59d8f7f964e47917e3fdde3d80793" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Raft RPCS is idempotent</span></span></li><li id="https://www.notion.so/25857d01645344b190de048af86672ca" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Randomization causes simplicity</span></span></li><li id="https://www.notion.so/0fd6e313aacf475a9006741b08c71cf5" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">Leader takes it all</span></span></li><li id="https://www.notion.so/a96aa3528a184d9cb2d093f55bf0f903" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">Logical timing instead of physical timing</span></span></li></ol><p id="https://www.notion.so/ab2f4293d4424fac8cbc892f6d34abd0" class="Equation" data-latex="broadcastTime â‰ª electionTimeout â‰ª MTBF"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>r</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>c</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>â‰ª</mo><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>â‰ª</mo><mi>M</mi><mi>T</mi><mi>B</mi><mi>F</mi></mrow><annotation encoding="application/x-tex">broadcastTime â‰ª electionTimeout â‰ª MTBF</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">â‰ª</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">â‰ª</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span></span></span></span></span></p><h2 id="https://www.notion.so/08b81fe39f8c4ee2b8cec6885acc32d6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/08b81fe39f8c4ee2b8cec6885acc32d6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Mind Trail</span></span></h2><a id="https://www.notion.so/6ef8a5c635664b7dad1d57c790f5e4df" class="Page" href="https://www.notion.so/6ef8a5c635664b7dad1d57c790f5e4df"><div><div class="Page__Icon"><div class="Icon">âœ”ï¸</div></div><div class="Page__Title"><span class="SemanticStringArray"><span class="SemanticString">lab2 Raft</span></span></div></div></a><h2 id="https://www.notion.so/eab1eca57d6a413fbbe5ceecf137481b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/eab1eca57d6a413fbbe5ceecf137481b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Difficulties &amp; solution</span></span></h2><h3 id="https://www.notion.so/f3e7e37991f94225862cdc82e385b4ff" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f3e7e37991f94225862cdc82e385b4ff"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2A</span></span></h3><div id="https://www.notion.so/605aa329d3a141599bfe575b0664fbf8" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Termä¸¥æ ¼å°çš„æ‰èƒ½ç»™Termå¤§çš„serveræŠ•ç¥¨ï¼Œä½†æ˜¯å®¹æ˜“å‡ºç°ä»¥ä¸‹æƒ…å†µ (å¿½ç•¥ç¬¬ä¸‰åˆ—)ï¼Œå³server S1å’ŒS2å‡ ä¹ä»¥åŒä¸€æ—¶é—´å¼€å§‹é€‰ä¸¾ (å³ä½¿å­˜åœ¨éšæœºtimeout)ï¼Œå¯¼è‡´å¤šè½®éƒ½æ— æ³•é€‰å‡ºleaderã€‚</span></span></del></div></div></div><details id="https://www.notion.so/b03c213eaa7a4f66941ccb3c10c1827e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/b21828d32d5a4832b90ff3970e343060" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 C0 ask for vote, T: 8                                                                                                                                     
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 7                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 8                            
                                                     S1 C0 ask for vote, T: 8                                                                                
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 8                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 9                            
                                                     S1 not leader, election timeout...                                                                      
                                                     S1 convert to candidate, calling election T: 8                                                          
                                                                                                         S2 C0 ask for vote, T: 9                            
                                                     S1 C0 ask for vote, T: 9                                                                                
S0 C0 ask for vote, T: 9                                                                                                                                     
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 9                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 10                           
                                                     S1 C0 ask for vote, T: 10                                                                               
                                                     S1 not leader, election timeout...                                                                      
                                                     S1 convert to candidate, calling election T: 9                                                          
                                                                                                         S2 C0 ask for vote, T: 10                           
S0 C0 ask for vote, T: 10                                                                                                                                    
S0 -&gt; S1 vote false, VT: 0                                                                                                                                   
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 10</span></span></span></code></pre></div></details><details id="https://www.notion.so/7629db759b254a7498d3be63f20896c4" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/b31b0909f74249fd965198c2194d7703" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨RequestVote RPCsä¸­å°±æ›´æ–°äº†è‡ªå·±çš„Termï¼Œä½¿å¾—è½åçš„serverä¸€ä¸‹å­å°±è¿½ä¸Šäº†å› randomè€Œé¢†å…ˆçš„server</span></span></li><li id="https://www.notion.so/f5d4eadb8aaf4762acf80196922c88a3" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">timeoutåŒºé—´ä¸º [150, 300] ms</span></span></li></ol></div></details><details id="https://www.notion.so/41cbd3f899fc40f8bc772c27c6cd8aaa" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">å¯èƒ½çš„è§£å†³åŠæ³•</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/64c3dfc68def4dfea1c324c8add64135" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike">ä¸åœ¨RequestVote RPCsä¸­æ›´æ–°Termã€‚
</del></span><span class="SemanticString">åœ¨æ›´æ–°ä»¥åæŠŠisTimeoutç½®ä¸ºfalseï¼Œè·³è¿‡ä¸€è½®é€‰ä¸¾è‡ªå¢ã€‚</span></span></li><li id="https://www.notion.so/fdb44b1cfd8549d0be5c92b819916352" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">å¢å¤§timeoutçš„åŒºé—´</span></span></li></ol></div></details><details id="https://www.notion.so/ec4dc3f6fde24fce80252296902193a7" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/2797780a8f2f45b4a562c4fb2a486df3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">é‡‡ç”¨äº†æ–¹æ³•1ï¼Œå¹¶å°†timeoutåŒºé—´ä¿®æ”¹ä¸º [200, 500] msï¼Œæš‚æ—¶è§£å†³é—®é¢˜ã€‚</span></span></p></div></div></details><div id="https://www.notion.so/9e4e8ad549e8409b8079a42edd1cc730" class="Divider"></div><div id="https://www.notion.so/17b7ed1226a946a8aa52f09b1c5a1e22" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">è§‚å¯Ÿç¬¬äºŒåˆ—å’Œæœ€åä¸€åˆ—ï¼Œå¯ä»¥å‘ç°è¿™é‡Œ S1 å’Œ S6 å‡ºç°äº†è„‘è£‚ç°è±¡ï¼Œä½†æ˜¯å¹¶æœªå¾—åˆ°è§£å†³ã€‚åŸå› æ˜¯ä¸¤æ–¹æ­¤æ—¶çš„Termç›¸åŒï¼Œä¸¤æ–¹äº’ç›¸ä¼šæ‹’ç»å¯¹æ–¹çš„heartbeat logè€Œä¸ä¼šè¿›è¡ŒçŠ¶æ€è½¬æ¢ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/72b781cd918e4bd7a8f1f3dfa5f9fb54" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/6375c1ab8b9049379e02364e165bbc8c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>                       S1 multi leaders(2)                                                                                                                 
                       T: 7                                                                                                                                
                                                                                                                                     S6 multi leaders(2) T:
                                                                                                                                     7                     
                                                                                                                                     S6 -&gt; S5 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                       S1 -&gt; S6 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                                             S2 convert to                                                                                                 
                                             candidate, calling                                                                                            
                                             election T: 7                                                                                                 
                                                                                                                                     S6 C0 ask for vote, T:
                                                                                                                                     8                     
                                                                                                                                     S6 -&gt; S0 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S1 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S2 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S3 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S4 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                       S1 -&gt; S0 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S2 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S3 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S4 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S5 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}</span></span></span></code></pre></div></details><details id="https://www.notion.so/f8446fca0e8c4e08b5e57007d6b86606" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/45fb4851545c4f74bd4140caa060bd26" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Termç›¸åŒï¼Œåœ¨èº«ä¸ºleaderçš„åŒæ—¶å¯¹å³™ï¼Œç”±äºæ‹’ç»äº†heartbeat logå¯¼è‡´çš„çŠ¶æ€æ— æ³•è½¬æ¢</span></span></li></ol></div></details><details id="https://www.notion.so/abd13b41aa774c57ac9b7fdcae8c06ef" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">å¯èƒ½çš„è§£å†³æ–¹æ³•</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/2abefa41f3be4e49b1764ae6a98696a9" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æœ¬è´¨ä¸Šæ˜¯åœ¨disconnectçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥è‡ªå·±çš„killed()ï¼ŒåŠæ—¶è½¬æ¢ä¸ºfollowerã€‚è®ºæ–‡ä¸­æ²¡æœ‰æåˆ°Termç›¸åŒçš„æƒ…å†µä¸‹Entry (Including heartbeat)çš„å¤„ç†æƒ…å†µã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/edbd0e3224b04c068922874c30b67686" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/d6164cc87bb34a50825676dfcb318e7b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨æ¯ä¸ªheartbeat loopä¸­æ£€æŸ¥killed()ï¼ŒåŠæ—¶è½¬æ¢çŠ¶æ€ã€‚</span></span></li><li id="https://www.notion.so/f5dc01e6e21a45468ed323697f27844c" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">è¿è¡Œæ—¶åˆå‘ç°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¸‹é¢åˆ†æå‡ºé—®é¢˜çš„ä»£ç ã€‚AppendEntryåˆ†ä¸ºä¸‰ä¸ªæƒ…å†µï¼ŒcurrTerm &lt; args.Term, currTerm = args.Term å’Œ currTerm &gt; args.Termã€‚</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ç¬¬ä¸€ç§æƒ…å†µ</strong></span><span class="SemanticString">æ²¡å•¥å¥½è¯´çš„ï¼Œ</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ç¬¬äºŒç§æƒ…å†µä¸‹</strong></span><span class="SemanticString">ï¼Œè‹¥serverè¿˜æœªæŠ•ç¥¨ (voteFor == -1) åˆ™serverä¸€å®šä¸æ˜¯Leaderï¼›æŠ•äº†ç¥¨çš„æƒ…å†µä¸‹æ‹’ç»å¯ä»¥ä¿è¯ä¸€ä¸ªTermåªæŠ•ä¸€æ¬¡ç¥¨çš„åŸåˆ™ã€‚ç¬¬ä¸‰ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ³¨æ„ï¼Œserverçš„çŠ¶æ€å¯èƒ½æ˜¯ä¸‰ä¸ªçŠ¶æ€ä¸­çš„ä»»æ„ä¸€ç§ï¼Œæ‰€ä»¥ä¸€å®šè¦é‡ç½®serverçš„çŠ¶æ€ä¸ºFolloweræ¥ä¿è¯Termå¤§çš„ä¼˜å…ˆçš„åŸåˆ™ã€‚</span></span></li></ol><pre id="https://www.notion.so/364d4adfbd824befa722ee82938a5b16" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if rf.currTerm &gt; args.Term {
	reply.VoteGranted = false
	DebugLog(dVote, &quot;S%d -&gt; S%d vote false, T: %d, CT: %d\n&quot;, rf.me, args.CandidateId, rf.currTerm, args.Term)
	return
} else if rf.currTerm == args.Term {
	if rf.votedFor == -1 {
		rf.votedFor = args.CandidateId
		reply.VoteGranted = true
		DebugLog(dVote, &quot;S%d -&gt; S%d vote true, same term\n&quot;, rf.me, args.CandidateId)
		return
	} else {
		reply.VoteGranted = false
		DebugLog(dVote, &quot;S%d -&gt; S%d vote false, VT: %d\n&quot;, rf.me, args.CandidateId, rf.votedFor)
		return
	}
} else {
	rf.currTerm = args.Term
	rf.isTimeout = false
	rf.state = Follower // !!!!!!!!!!!!!! IMPORTANT !!!!!!!!!!!!!!
	rf.votedFor = args.CandidateId
	reply.VoteGranted = true
	DebugLog(dVote, &quot;S%d -&gt; S%d vote true, from T: %d to CT: %d\n&quot;, rf.me, args.CandidateId, reply.Term, rf.currTerm)
	return
}</span></span></span></code></pre></div></details><div id="https://www.notion.so/fabb2e4adc2b45599f4b8de06ac70a63" class="Divider"></div><div id="https://www.notion.so/16a392fd50164c68aa28e5ee4e794432" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/d0c3788848874dde882bb4721967ed7b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>humborn@shin MIT-6.5840/src/raft on master [!] [!]                                                                                        ó±‘† 09:36:06
 âœ go test -run 2A                                    
Test (2A): initial election ...
  ... Passed --   3.0  3   58   15440    0
Test (2A): election after network failure ...
  ... Passed --   4.4  3  140   27904    0
Test (2A): multiple elections ...
  ... Passed --   6.2  7  686  129664    0
PASS
ok      6.824/raft      13.599s</span></span></span></code></pre></div></div><div id="https://www.notion.so/c29551f9871a42d996a238e5fcaa7dda" class="Divider"></div><div id="https://www.notion.so/be45045ec3e14eae8607ac086be6caae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/7227d34865d647ca979391b945c429f5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/7227d34865d647ca979391b945c429f5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2B</span></span></h3><div id="https://www.notion.so/d89bd40651634125bc6a1b8cf594dcf3" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Serveråœ¨æˆåŠŸappendä»¥åï¼Œç«Ÿç„¶æ²¡æœ‰è®©Leaderæ›´æ–°commitIndex</span></span></del></div></div></div><details id="https://www.notion.so/dbf29318f1ec4885a273cc72e10cf9d5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/9c671f61d7084171adb6aac8e881ce8d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 not leader, election timeout...                                                                                                                         
                                        S1 -&gt; S2 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
                                                                               S2 not leader, election timeout...                                          
                                        S1 -&gt; S2 T: 1, send {PLI: 1, PLT: 1,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 1, PLT: 1,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
                                        S1 -&gt; S2 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
FAIL
FAIL    6.824/raft      2.313s</span></span></span></code></pre></div></details><details id="https://www.notion.so/18d358ebf5394e7f9bcc7fdac9bece12" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/4b874fbd61564ebd9295b6bd86c9459b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">sortä¸­ç´¢å¼•æœ‰é—®é¢˜ï¼ŒåŸæ¥æ˜¯ä»å°åˆ°å¤§æ’åºåï¼Œå–len(rf.peers)/2-1ï¼Œå½“#Serverä¸º3æ—¶ï¼Œç»“æœä¸º0,å¾ˆæ˜¾ç„¶ä¸å¯¹ã€‚</span></span></li><li id="https://www.notion.so/7eac1410f7ed4696a30e15f2d64300eb" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">æé”™ç´¢å¼•äº†ï¼ŒAppendEntriesæ—¶å¯èƒ½ä¼šä¼ å…¥ç©ºEntriesã€‚è¿™æ—¶æƒ³æ™®é€‚åœ°æ»¡è¶³AppendEntries RPCsçš„æœ€åä¸€æ¡å®ç°è§„åˆ™ï¼Œå°±éœ€è¦å–serverè‡ªèº«logEntriesçš„æœ€åä¸€æ¡entryçš„index</span></span></li><li id="https://www.notion.so/c1d128eec75548d09542b293f384d79a" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">åˆ›å»ºæ–°logEntryæ—¶indexå’Œtermä½ç½®åäº†ï¼Œcao!</span></span></li></ol></div></details><details id="https://www.notion.so/4afce0da520c4ab3a8df19cbbcdb0688" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/4bf00e546fd84a9bbc309f28d319e03e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æ”¹ä¸º(len(rf.peers)-1)/2</span></span></li><li id="https://www.notion.so/ac59d673390d4300ac7fa5621f0c3f61" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">ç”±args.Entriesâ†’rf.logEntrieså–æœ€åä¸€ä¸ªentryçš„index</span></span></li><li id="https://www.notion.so/64ed1d6dda8947ada5019fcdd8242751" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">caoï¼</span></span></li></ol></div></details><details id="https://www.notion.so/585f9a294dcb4429882b927b52dcc991" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Task log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/adef53bd473c4e0e9ce81187d7309ba9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run BasicAgree                          
Test (2B): basic agreement ...
  ... Passed --   0.5  3   16    4258    3
PASS
ok      6.824/raft      0.494s</span></span></span></code></pre></div></details><div id="https://www.notion.so/fddcd36ee5844cf88ececa59c887248b" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">å¦‚æœä¸€ä¸ªserveræ‰çº¿äº†ï¼Œä¼šä¸æ–­</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">StartElection()</code></span><span class="SemanticString">è‡ªå¢ï¼Œå½“å®ƒé‡è”æ—¶ï¼Œå®ƒçš„Termå°†ä¼šå¾ˆå¤§ã€‚å°±ä¼šå¯¼è‡´ä¸€ä¸ªæƒ…å†µï¼Œå½“å‰ leader çš„ AppendEntries RPCs å°†ä¼šè¢«æ‹’ç»ï¼Œreplyä¸­çš„Termå·¨å¤§ï¼Œä¼šå°†Leaderæ‰“å›Followerå¹¶æ›´æ–°Term,æœ€å¥½ç»™Leaderç‰¹æƒï¼Œè®©Leaderå°½å¿«timeout,å†æ¬¡æˆä¸ºLeaderï¼›ç”±å®ƒå¬å¼€çš„Electionä¹Ÿä¼šè¢«å…¶ä»–serveræ‹’ç»(LastLogIndexå¾ˆå°)å¹¶ä½¿å…¶ä»–serveræ›´æ–°Termï¼Œä¸ç”¨ç»™ç‰¹æƒé€šé“ã€‚ä½†æ˜¯åœ¨ä¸‹æ–¹logä¸­
</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">S0 apply msg: {true 101 1 false [] 0 0} 
</em></span><span class="SemanticString">é‡å¤å‡ºç°ï¼Œä¸”é‡è”åï¼Œå¹¶æœªä¸€ç›´å°è¯•Append(åœ¨ç¬¬ä¸€æ¬¡è¢«æ‹’ç»å)å¯¼è‡´æ²¡æœ‰åŠæ—¶æ›´æ–°ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/73f3d2269d074b25923b5b140a7558cc" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/118c02603d5445c18658eff3a68881a9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 reconnect...                                                                                                                                                
                                                                                                           S2 recv command, LENLOG: 6, T: 1                    
                                                                                                           S2 send to S1, ENTRIES: [{106 1 6}]                 
                                                                                                           S2 send to S0, ENTRIES: [{102 1 2} {103 1 3} {104 1 
                                                                                                           4} {105 1 5} {106 1 6}]                             
                                                      S1 recv append from S2, T: 1, ENTRIES: [{106 1 6}]                                                       
                                                      S1 -&gt; S2 append ok T: 1, LENLOG: 7                                                                       
S0 recv append from S2, T: 1, ENTRIES: [{102 1 2}                                                                                                              
{103 1 3} {104 1 4} {105 1 5} {106 1 6}]                                                                                                                       
S0 append fail, T: 6 large term                                                                                                                                
                                                                                                           S2 -&gt; S1 T: 1, send {PLI: 5, PLT: 1, CI: 5,         
                                                                                                           BEGINLOGIDX: 6, ENDLOGIDX: 6, LOG: [{106 1 6}]}     
                                                                                                           S2 update commitIndex CI: 6                         
                                                                                                           S2 apply msg: {true 106 6 false [] 0 0}             
                                                                                                           S2 -&gt; S0 T: 1, send {PLI: 1, PLT: 1, CI: 5,         
                                                                                                           BEGINLOGIDX: 2, ENDLOGIDX: 6, LOG: [{102 1 2} {103 1
                                                                                                           3} {104 1 4} {105 1 5} {106 1 6}]}                  
                                                                                                           S2 convert to candidate, calling election T: 6      
                                                      S1 C6 ask for vote, T: 7                                                                                 
S0 C6 ask for vote, T: 7                                                                                                                                       
                                                      S1 -&gt; S2 vote true, from T: 1 to CT: 7                                                                   
S0 -&gt; S2 vote true, from T: 6 to CT: 7                                                                                                                         
                                                                                                           S2 convert to leader at T: 7                        
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                      S1 apply msg: {true 106 6 false [] 0 0}                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 6                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 5                     
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 4                     
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, fail send {PLI: 1, PLT: 1, CI: 4}    
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 3                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 2                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 -&gt; S2 recv heartbeat                                                                                                                                        
S0 apply msg: {true 101 1 false [] 0 0}                                                                                                                        
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, fail send {PLI: 1, PLT: 1, CI: 3}    
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 -&gt; S2 recv heartbeat                                                                                                                                        
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat</span></span></span></code></pre></div></details><details id="https://www.notion.so/c7280862fa9f4d91bf3e19f76ec4ee7e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/f2b1f2601dd94250b2cc3c693215eb09" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åªè¦leaderCommitæ¯”è‡ªå·±çš„commitIdè¦å¤§ï¼Œå°±ä¼šä¿¡å·æç¤ºapplyMsgã€‚</span></span></li><li id="https://www.notion.so/cd24ba08a13742bd88bbb213fd9999bb" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">é‡è”åä¼šé‡æ–°é€‰ä¸¾Leaderï¼Œä¹Ÿå°±æ˜¯è¯´é‡æ–°é€‰å‡ºçš„Leaderä¼šé‡æ–°åˆå§‹åŒ–è‡ªå·±çš„nextIndexã€‚è‡ªç„¶çš„ï¼Œç¬¬ä¸€æ¬¡å°è¯•å¯¹é‡è”çš„Serverè¿›è¡Œappendä¼šå› ä¸ºæ²¡æœ‰åŒ¹é…çš„indexè€Œè¢«æ‹’ç»ï¼Œäºæ˜¯å¯„äº†ã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/8627a1a79d04419ea97d4f2a1a29a760" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/cba70ab2c56c4573bebf9866c12c0788" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ä¸å†å¯¹heartbeatç‰¹æ®Šå¯¹å¾…ï¼Œä¹Ÿå°±æ˜¯è¯´heartbeatå’Œbroadcastäº‰æŠ¢å¯¹Serverçš„æ›´æ–°</span></span></li></ol><div id="https://www.notion.so/bac3530026e84724af93be2b5123e6e0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></div></details><div id="https://www.notion.so/c62ccd03b3274e23a8f584e98523ff4d" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Apply massageçš„æ—¶å€™å‡ºç°äº†é¡ºåºå‡ºé”™çš„é—®é¢˜</span></span></del></div></div></div><details id="https://www.notion.so/c60ca3ca7e8c4b619d9544b93bf49807" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/20fcb1fbca204da9a71d7b636a7fe50a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>// log
S0 commitIndex: 6                                                                                                                                                    
S0 -&gt; S2 append ok T: 9, LENLOG: 7                                                                                                                                   
                                                                                                               S2 -&gt; S1 T: 9, send heartbeat                         
                                                                                                               S2 -&gt; S1 update success, NEXT: [1 7 7], MATCH: [0 6 0]
                                                                                                               S2 get N: 6                                           
S0 apply msg: {true 106 6 false [] 0 0}                                                                                                                              
S0 ######## CI: 6, cfg.log: [map[0:init server 1:101]                                                                                                                
map[0:init server 1:101 2:102 3:103 4:104 5:105 6:106]                                                                                                               
map[0:init server 1:101 2:102 3:103 4:104 5:105 6:106]]                                                                                 S2 -&gt; S0 T: 7, send heartbeat


// related code
func (cfg *config) checkLogs(i int, m ApplyMsg) (string, bool) {
	err_msg := &quot;&quot;
	v := m.Command
	for j := 0; j &lt; len(cfg.logs); j++ {
		if old, oldok := cfg.logs[j][m.CommandIndex]; oldok &amp;&amp; old != v {
			log.Printf(&quot;%v: log %v; server %v\n&quot;, i, cfg.logs[i], cfg.logs[j])
			// some server has already committed a different value for this entry!
			err_msg = fmt.Sprintf(&quot;commit index=%v server=%v %v != server=%v %v&quot;,
				m.CommandIndex, i, m.Command, j, old)
		}
	}

	DebugLog(dDrop, &quot;S%d ######## CI: %d, cfg.log: %v\n&quot;, i, m.CommandIndex, cfg.logs)
	_, prevok := cfg.logs[i][m.CommandIndex-1]
	cfg.logs[i][m.CommandIndex] = v
	if m.CommandIndex &gt; cfg.maxIndex {
		cfg.maxIndex = m.CommandIndex
	}
	return err_msg, prevok
}</span></span></span></code></pre></div></details><details id="https://www.notion.so/4583313e4c014c588818cd210176fd63" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/fc1869b0b3744410a60b5d2c91eb1dad" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">é¦–å…ˆï¼Œchanæ˜¯ä¸€ä¸ªfifoã€‚è¿™é‡Œä¼šæ ¹æ®fifoä¸­åå‡ºçš„ApplyMsgè¿›è¡Œåˆ¤æ–­ï¼Œå°†ApplyMsgä¸­çš„ä¿¡æ¯æå–å¹¶å‚¨å­˜åœ¨cfg.logä¸­ã€‚Serveré‡è”åï¼Œä»…æ”¾å…¥æœ€æ–°çš„ApplyMsgä¼šå¯¼è‡´index out of rangeçš„é—®é¢˜ã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/6580f888b1ea4643a0c57622c45034aa" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/462c48c100b7482ba7cf0ccba1bbf19c" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ä¹Ÿå°±æ˜¯è¯´ï¼Œéœ€è¦æŒ‰ç…§é¡ºåºå¾€chané‡Œä¸€ä¸ªä¸€ä¸ªæ”¾å…¥ApplyMsgè€Œä¸æ˜¯ä»…æ”¾å…¥æœ€æ–°çš„ApplyMsgã€‚</span></span></li></ol></div></details><div id="https://www.notion.so/8c055772c67a4807bc3ad388bb474e55" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/404240dd19bc41839cc8656894095f5b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run 2B   
Test (2B): basic agreement ...
  ... Passed --   0.5  3   16    4290    3
Test (2B): RPC byte count ...
  ... Passed --   1.3  3   48  113614   11
Test (2B): agreement after follower reconnects ...
  ... Passed --   5.3  3  192   50800    8
Test (2B): no agreement if too many followers disconnect ...
  ... Passed --   3.4  5  264   51340    3
Test (2B): concurrent Start()s ...
  ... Passed --   0.6  3   24    6790    6
Test (2B): rejoin of partitioned leader ...
  ... Passed --   3.9  3  146   35480    4
Test (2B): leader backs up quickly over incorrect follower logs ...
  ... Passed --  14.0  5 2244 1728755  102
Test (2B): RPC counts aren&#x27;t too high ...
  ... Passed --   2.0  3   62   18665   12
PASS
ok      6.824/raft      31.039s</span></span></span></code></pre></div></div><h3 id="https://www.notion.so/05451af5101c4742901e74a89a9773e5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/05451af5101c4742901e74a89a9773e5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2C</span></span></h3><div id="https://www.notion.so/3647952aea0149e3bf7d90357850ace1" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">ä¸€è¿è¡Œåˆ°unrealiableçš„testå°±å‡ºç°out of indexçš„é”™è¯¯ï¼Œç°åœ¨æƒ³æ¥å¥½åƒåœ¨</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2B</strong></span><span class="SemanticString">ä¸­å¶å°”ä¹Ÿä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œè¿˜å€ºäº†å±äºæ˜¯ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/afe0b15e036f4360b998ea33e625da4e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/d5137da7c2c2438999204f5bcea51cd9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run UnreliableChurn
Test (2C): unreliable churn ...
panic: runtime error: index out of range [8] with length 8

goroutine 22 [running]:
6.824/raft.(*Raft).Apply(0xc0001b2000)
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:596 +0x214
created by 6.824/raft.Make
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:757 +0x3d6
exit status 2
FAIL    6.824/raft      0.300s</span></span></span></code></pre></div></details><details id="https://www.notion.so/9a039b4173e141769619a195ea754929" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/66c53012b2f14f978c3da2565ae695b8" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¾ˆå¥‡æ€ªï¼Œæœ‰æ—¶å¯ä»¥é€šè¿‡ï¼Œæœ‰æ—¶ä¸è¡Œï¼Œ2Cä¸­çš„Unreliableæµ‹è¯•æ”¾å¤§äº†ç³»ç»Ÿçš„å¼±ç‚¹ï¼Œå¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œå¿ƒè·³é—´éš”çš„è®¾ç½®å’Œè¿™ä¸ªé”™è¯¯æ˜¯æœ‰å…³çš„ã€‚åæ¥å‘ç°åŸæ¥æ˜¯å› ä¸ºå»¶è¿Ÿï¼ŒFolloweræ¥å—äº†Indexæ›´å¤è€çš„æ¶ˆæ¯ï¼Œå¹¶è¦†ç›–äº†æ–°çš„æ¶ˆæ¯ã€‚</span></span><pre id="https://www.notion.so/fb79b3cdd9f34064a6bb45b455c7b168" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 reconnect...                                                                                                                                  
                              S1 reconnect...                                                                                                    
                                                           S2 reconnect...                                                                       
                                                                                        S3 reconnect...                                          
                                                                                        S3 -&gt; S4 append ok T: 26,                                
                                                                                        LENLOG: 207                                              
                                                                                                                     S4 -&gt; S2 LogInfo {IDX: 192, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 192,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S2, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                                                     S4 -&gt; S3 update success,    
                                                                                                                     NEXT: [193 205 193 207 193],
                                                                                                                     MATCH: [0 204 0 206 0]      
                                                                                                                     S4 get N: 204               
                                                                                                                     S4, LENLOG: 207, LA: 204    
                                                                                                                     apply msg {CI: 205}         
                                                                                                                     S4 -&gt; S3 LogInfo {IDX: 206, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 206,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S3, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                              S1 -&gt; S4 append ok T: 26,                                                                                          
                              LENLOG: 207                                                                                                        
                                                           S2 append fail, T: 27 large                                                           
                                                           term                                                                                  
                                                                                                                     S4 -&gt; S1 update success,    
                                                                                                                     NEXT: [193 207 193 207 193],
                                                                                                                     MATCH: [0 206 0 206 0]      
                                                                                                                     S4 get N: 206               
                                                                                                                     S4 update commitIndex CI:   
                                                                                                                     206                         
                                                                                                                     S4, LENLOG: 207, LA: 205    
                                                                                                                     apply msg {CI: 206}         
                                                                                                                     S4 -&gt; S2 LogInfo {IDX: 192, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 192,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S2, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                        S3 commit {CI: 205, LENLOG:                              
                                                                                        207}                                                     
                                                           S2 append fail, T: 27 large                                                           
                                                           term                                                                                  
                                                                                                                     S4 reconnect...             
                              S1 -&gt; S4 append ok T: 26,                                                                                          
                              LENLOG: 206                                                                                                        
                                                                                                                     S4 -&gt; S1 LogInfo {IDX: 206, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 206,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S1, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                        S3 -&gt; S4 append ok T: 26,                                
                                                                                        LENLOG: 205</span></span></span></code></pre></li><li id="https://www.notion.so/81d2c6930a524498beac28c6da665860" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">æœ‰æ—¶å€™ä¼šå‡ºç°ç´¢å¼•å–åˆ°-1çš„æƒ…å†µï¼Œæ’æŸ¥å‡ºæ˜¯appendæ—¶æ¡ä»¶è®¾ç½®æœ‰è¯¯ã€‚æ­¤å¤–ï¼Œå½“ä¸€ä¸ªServer detachä»¥åï¼Œä¼šæŒç»­å‘åˆ«çš„serverå‘é€ä¿¡æ¯ï¼Œä¸æ–­æ”¶åˆ°fail updateï¼Œè‡ªç„¶ä¼šä¸æ–­å‡å°nextIndexçš„å€¼ã€‚ç›´åˆ°nextIndexå˜ä¸º0,è‡ªå‡åå˜ä¸º-1,ç´¢å¼•è¶Šç•Œã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/0b4c5a92b41342209bd380bc7e172c16" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/99972ea87afb401ca01665d03db6cbd9" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ä¿®æ”¹æ¡ç›®æ›´æ–°çš„è§„åˆ™ï¼Œéµå¾ªVoteRequest RPCsä¸­çš„up-to-dateåŸåˆ™ã€‚</span></span><pre id="https://www.notion.so/7c21d5951b8145ebbf990c0114d046c9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if len(args.Entries) == 0 {
	DebugLog(dLog, &quot;S%d -&gt; S%d recv heartbeat\n&quot;, rf.me, args.LeaderId, rf.currTerm, len(rf.logEntries))
} else {
	rfLastLogIndex, rfLastLogTerm := rf.LogInfoByIndex(len(rf.logEntries) - 1)
	argLastLogIndex, argLastLogTerm := args.Entries[len(args.Entries)-1].Index, args.Entries[len(args.Entries)-1].Term
	if rfLastLogTerm &lt; argLastLogTerm || (rfLastLogTerm == argLastLogTerm &amp;&amp; rfLastLogIndex &lt; argLastLogIndex) {
		rf.logEntries = rf.logEntries[:args.PrevLogIndex+1]
		rf.logEntries = append(rf.logEntries, args.Entries...) // persist
		rf.persist()
	}

	DebugLog(dLog2, &quot;S%d -&gt; S%d append ok T: %d, LENLOG: %d\n&quot;, rf.me, args.LeaderId, rf.currTerm, len(rf.logEntries))
}</span></span></span></code></pre><div id="https://www.notion.so/04b147afe6104a02a7ab9ff6c5d5a8e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åŒæ—¶è¦æ³¨æ„ä¿®æ”¹replyå¤„ç†éƒ¨åˆ†çš„ä»£ç ï¼Œä¸ç„¶ä¼šå°†nextIndexå’ŒmatchIndexæ›´æ–°æˆæ—§çš„ç´¢å¼•ã€‚</span></span></p></div><pre id="https://www.notion.so/4b123569fe2b4e3f92be0aa94bb29ee5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if reply.Success {
	if rf.nextIndex[id] &lt; endOfIndex {
		rf.nextIndex[id] = endOfIndex
		rf.matchIndex[id] = endOfIndex - 1
		DebugLog(dError, &quot;S%d -&gt; S%d update success, NEXT: %v, MATCH: %v\n&quot;, rf.me, id, rf.nextIndex, rf.matchIndex)
		go rf.updateCommitIndex()
	}
	// è®²é“ç†ï¼Œæ›´æ–°æˆåŠŸå°±è¦è¯•è¯•èƒ½ä¸èƒ½update commitIndex
} else {
	rf.nextIndex[id] /= 2
	DebugLog(dError, &quot;S%d -&gt; S%d update failed, NEXT: %d\n&quot;, rf.me, id, rf.nextIndex[id])
}</span></span></span></code></pre></li><li id="https://www.notion.so/9e885df2c0c04a71b0506b8e60deb64a" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">è´´å‡ºé”™è¯¯ä»£ç </span></span><pre id="https://www.notion.so/fb0384cd51744f36862384c25db6ae9e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike"><span>if args.PrevLogIndex &gt;= len(rf.logEntries) || rf.logEntries[args.PrevLogIndex].Term != args.PrevLogTerm {
</span></del></span><span class="SemanticString"><span>if args.PrevLogIndex &gt; len(rf.logEntries)-1 || rf.logEntries[args.PrevLogIndex].Term != args.PrevLogTerm {
	reply.Success = false
	DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
	return
}</span></span></span></code></pre><div id="https://www.notion.so/5ca86251dda544a2b2882879468df96b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ­¤å¤–ï¼Œæ‰“äº†ä¸ªè¡¥ä¸ï¼Œè®©nextIndexç­‰äºmax(1, nextIndex/2)ï¼Œä¸çŸ¥é“è¿™ä¸ªè¡¥ä¸å¯ä¸å¯ä»¥ç¾åŒ–ã€‚</span></span></p></div></li></ol></div></details><div id="https://www.notion.so/ea7202ad94cd4f2f87f03ce958c46f26" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">æœ‰æå°çš„æ¦‚ç‡å‡ºç°é—®é¢˜ï¼šApplyMsgé¡ºåºé”™ä½ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/e99263c4bfbd45dbb85bbc66afd3b697" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/137b7a2389d34ee9b8ab32ae0f90d231" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2C): Figure 8 (unreliable) ...
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
apply error: commit index=52 server=3 2540 != server=4 9070</span></span></span></code></pre></div></details><details id="https://www.notion.so/8b37dc82794549d3a6f2235a71c48210" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/aabfb220e26b47fca32781b478e64a81" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æ²¡æ’æŸ¥å‡ºæ¥</span></span></li></ol></div></details><details id="https://www.notion.so/2609d0476661499a9034430f9c26ce21" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/432e6467f6fd42da965676abed4808ef" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å°†AppendEntriesä¸­çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">defer rf.applyCh.Signal()</code></span><span class="SemanticString"> å˜æˆäº† </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rf.applyCh.Signal()</code></span></span></li></ol></div></details><div id="https://www.notion.so/e151de3aedca4fc28718626205986bd8" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/560d76947c4a4e3381268ea767dce5bd" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run 2C                                               
Test (2C): basic persistence ...
  ... Passed --   3.1  3   78   18954    6
Test (2C): more persistence ...
  ... Passed --  14.4  5 1036  200240   16
Test (2C): partitioned leader and one follower crash, leader restarts ...
  ... Passed --   1.3  3   36    8539    4
Test (2C): Figure 8 ...
  ... Passed --  27.0  5 1180  256006   58
Test (2C): unreliable agreement ...
  ... Passed --   1.7  5 1048  345471  246
Test (2C): Figure 8 (unreliable) ...
  ... Passed --  33.6  5 19228 18476272  138
Test (2C): churn ...
  ... Passed --  16.4  5 6992 9763562 1432
Test (2C): unreliable churn ...
  ... Passed --  16.1  5 4236 5664994  384
PASS
ok      6.824/raft      113.623s</span></span></span></code></pre></div></div><h3 id="https://www.notion.so/d6b18336cd85414987d8d4c31bc3a38a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d6b18336cd85414987d8d4c31bc3a38a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2D</span></span></h3><blockquote id="https://www.notion.so/5589b63c074041c48210baf106a6f250" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">åœ¨2Dä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œåˆ‡ç‰‡åº•å±‚æ˜¯æ•°ç»„å®ç°ï¼Œå¦‚æœæƒ³è¦è®©GC reachåˆ°è¢«snapshotæ‰çš„æ— ç”¨å†…å­˜ï¼Œå°±éœ€è¦é‡æ–°åˆ›å»ºåˆ‡ç‰‡ï¼ŒåŸåˆ‡ç‰‡æŒ‡é’ˆç½®ç©ºã€‚</span></span></blockquote><div id="https://www.notion.so/95f9b1f44b3541158e10483066ca958f" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">æœ‰æ¦‚ç‡å‡ºç°é—®é¢˜ï¼šåœ¨æ›´æ–°commitIndexçš„æ—¶å€™å‡ºç°out of Indexé—®é¢˜ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/f5e4c3bd2a7b4b81a49b2e3f736dd940" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/da53c7bc194e42d496400af4e5ddd737" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2C): unreliable churn ...
panic: runtime error: index out of range [1656] with length 1656

goroutine 106315 [running]:
6.824/raft.(*Raft).updateCommitIndex(0xc000136200)
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:647 +0x345
created by 6.824/raft.(*Raft).broadcastAppendEntries.func1
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:622 +0x796
exit status 2</span></span></span></code></pre></div></details><details id="https://www.notion.so/562370472eb546c49822138d6ff25cdd" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/ef1ccf8d2d04422c941e2eb274e58871" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">updateCommitIndexå‡½æ•°åŸæœ¬æ˜¯ä½¿ç”¨åç¨‹å®ç°çš„ï¼Œæ‰€ä»¥æœ‰æå°çš„æ¦‚ç‡ï¼Œåœ¨updateCommitIndexä¹‹å‰ï¼Œå®Œæˆäº†Leaderè½¬æ¢ã€é‡æ–°å¹¿æ’­ã€æ›´æ–°æ–°çš„CommitIndexè¿™ä¸€ç³»åˆ—æ“ä½œã€‚ä½¿å¾—ä¸€å¼€å§‹çš„æ›´æ–°åç¨‹å‡ºç°è¶Šç•Œã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/db8374742dc14769a38ffd5b2caf63ac" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c7f0bd646114432ab6eee0279fe02b29" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">çº¿æ€§æ‰§è¡ŒupdateCommitIndexï¼Œå»é™¤å‡½æ•°ä¸­çš„åŠ é”æ“ä½œï¼Œç»Ÿä¸€ç”±ä¸»åç¨‹ç®¡ç†é”</span></span><pre id="https://www.notion.so/afb6d7e565d540dcb6b09d63d685af36" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>func (rf *Raft) updateCommitIndex() {
	// rf.mu.Lock()
	// defer rf.mu.Unlock()

	var dupMatchIndex []int
	dupMatchIndex = append(dupMatchIndex, rf.matchIndex...)
	dupMatchIndex[rf.me] = rf.logEntries[len(rf.logEntries)-1].Index
	sort.Ints(dupMatchIndex)
	DebugLog(dError, &quot;S%d get N: %d\n&quot;, rf.me, dupMatchIndex[(len(rf.peers)-1)/2])

	var N int = dupMatchIndex[(len(rf.peers)-1)/2]
	if N &gt; rf.commitIndex &amp;&amp; rf.logEntries[N].Term == rf.currTerm {
		rf.commitIndex = N
		defer rf.applyCond.Signal()
		DebugLog(dError, &quot;S%d update commitIndex CI: %d\n&quot;, rf.me, rf.commitIndex)
	}
}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/2aff85104af44f4aa996aec6b9861a78" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">æ­»é”é—®é¢˜ï¼šä¸€å¼€å§‹æ‰§è¡ŒSnapshotå‡½æ•°å°±å¡åœ¨è·å¾—é”çš„æ“ä½œè¿™é‡Œã€‚</span></span></del></div></div></div><details id="https://www.notion.so/c6351b11e39f42e7bf5af5d67da0bab5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/7606240c69314cc780f0454c4eb87540" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 -&gt; S1 append ok T: 1,                                                      
                                                      LENLOG: 14                                                                    
                            S1 start create snapshot                                                                                
                            LII: 9, T: 1                                                                                            
                            S1 start create snapshot,                                                                               
                            before lock                                                                                             
                            S1, LENLOG: 14, LA: 1                                                                                   
                            apply msg {CI: 10}                                                                                      
S0 convert to candidate,                                                                                                            
calling election T: 1                                                                                                               
S0 LogInfo {IDX: 1, LENLOG:                                                                                                         
2, LOG:                                                                                                                             
{7859782014890577642 1 1}}                                                                                                          
                                                      S2 C1 ask for vote, T: 2                                                      
                            S1 C1 ask for vote, T: 2                                                                                
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 -&gt; S0 vote false, old                                                      
                                                      log                                                                           
                                                      S2 convert to candidate,                                                      
                                                      calling election T: 2                                                         
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                            S1 C1 ask for vote, T: 3                                                                                
S0 C1 ask for vote, T: 3                                                                                                            
S0 LogInfo {IDX: 1, LENLOG:                                                                                                         
2, LOG:                                                                                                                             
{7859782014890577642 1 1}}                                                                                                          
S0 -&gt; S2 vote true, from T:                                                                                                         
2 to CT: 3                                                                                                                          
                                                      S2 convert to leader at                                                       
                                                      T: 3                                                                          
                                                      S2 -&gt; S1 LogInfo {IDX:                                                        
                                                      13, LENLOG: 14, LOG:                                                          
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}</span></span></span></code></pre></div></details><details id="https://www.notion.so/94e543bf67554d4e926e0122791273d3" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/a2f0bf183dd64e4480afd3c3393c340f" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¿«ç…§çš„é—´éš”æ˜¯æ¯10æ¡commandè¿›è¡Œä¸€æ¬¡å¿«ç…§ï¼Œå› æ­¤èŠ‚ç‚¹åœ¨è¿›è¡Œå°†å·²ç»æäº¤äº†çš„æŒ‡ä»¤å‘é€åˆ°applyChè¿›è¡Œæ‰§è¡Œçš„æ—¶å€™ä¸èƒ½è·å–æœ‰rf.muè¿™ä¸ªäº’æ–¥é”ï¼Œå› ä¸ºåœ¨ä½ æäº¤æŒ‡ä»¤å¹¶å°†è¯¥æŒ‡ä»¤å‘é€åˆ°applyChæ‰§è¡Œçš„åŒæ—¶ï¼Œæµ‹è¯•è„šæœ¬ä¼šè°ƒç”¨Snapshotå‡½æ•°è¿›è¡Œå¿«ç…§ï¼Œä½†æ˜¯æˆ‘è®¾è®¡çš„è¿™ä¸ªå‡½æ•°ä¹Ÿéœ€è¦è·å–rf.muäº’æ–¥é”ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥æ­»é”çŠ¶æ€ï¼šæ— æ³•è·å–rf.muäº’æ–¥é”è¿›è¡Œå¿«ç…§ï¼Œå¦ä¸€è¾¹æ˜¯éœ€è¦ç­‰å¿«ç…§ç»“æŸæ‰èƒ½ç»§ç»­æäº¤æŒ‡ä»¤å¹¶æ‰§è¡Œï¼Œä»¥åŠåç»­åŠ¨ä½œã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/9b67e71561714b68bc9fe05ba672ceb1" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/2da389e00f714bcb9368e274c78d24a5" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨Applyå‡½æ•°ä¸­è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹</span></span><pre id="https://www.notion.so/1383e8795f5643e5a9e491a2d174cffb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	++	rf.mu.Unlock()
			rf.applyCh &lt;- msg
	++	rf.mu.Lock()</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/ab228a28a23a4b8cbbdf370ad5a4494d" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">AppendEntriesä¸­å‡ºç°è´Ÿæ•°çš„Logç´¢å¼•</span></span></del></div></div></div><details id="https://www.notion.so/41348277d92a4fc899b6bf2f00d1705d" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/9c92c9e947dc4f1aa655b8ab608a1ab2" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åŸæ¥åªéœ€è¦æ£€æŸ¥args.PrevLogIndexå°äºç­‰äºLogæœ€åä¸€é¡¹çš„ç´¢å¼•å€¼ã€‚ä½†æ˜¯åœ¨å¼•å…¥snapshotåè¿˜éœ€è¦æ£€æŸ¥args.PrevLogIndexå¤§äºç­‰äºlastIncludedIndexï¼Œå› ä¸ºå†å²çš„AppendEntries RPCå¯ä»¥å»¶è¿ŸæŠµè¾¾</span></span><pre id="https://www.notion.so/1968a9a46b484f90860ea684086796c8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.PrevLogIndex &gt; rf.logEntries[len(rf.logEntries)-1].Index ||
		rf.logEntries[args.PrevLogIndex-rf.snapshot.LastIncludedIndex].Term != args.PrevLogTerm { // ATTENTION è¿™é‡Œå¯èƒ½ä¼šè¶Šç•Œï¼Œè¦å‡å»lastincludedindex
		reply.Success = false
		DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/965b8981adbf4d3ab0ed424967c6a409" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/b88fb5a5ef144feeb82c5b46418466a8" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥å°†replyçš„successç½®trueå¹¶è¿”å›ï¼Œå› ä¸ºå¯¹äºæˆåŠŸæ—¶è¿”å›å€¼çš„å¤„ç†å·²ç»è€ƒè™‘åˆ°äº†å»¶è¿Ÿæ¶ˆæ¯ï¼ˆ2Cï¼‰</span></span><pre id="https://www.notion.so/3deabfd4394e4149be70aacca665fd46" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if rf.snapshot.LastIncludedIndex &gt; args.PrevLogIndex {
		reply.Success = true
		DebugLog(dVote, &quot;S%d append success, snapshot interrupt...\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/0f1d3ca89b3c4dcfa4f6742c18f11454" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">broadcastä¸­å‡ºç°è´Ÿæ•°çš„Logç´¢å¼•</span></span></del></div></div></div><details id="https://www.notion.so/0f7f8d104ba64ea198b7e85c809b0d9a" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/b47b1fcd85ff499fb9794c1dc1d8ada4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">nextIndex[0] == snapshot.lastIncludedIndex</span></span></p></div><pre id="https://www.notion.so/bba27868dc174b66b403611f833e1055" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S1 -&gt; S0 LogInfo {IDX: 108,                                                                                                 
                                 LENLOG: 8, LOG:                                                                                                             
                                 {5178380306894727311 1 116}},                                                                                               
                                 NEXT: [109 1 117], SS: {109 1}                                                                                              
                                                                S2, LENLOG: 18, LA: 108 apply                                                                
                                                                msg {CI: 109}                                                                                
                                                                S2, LENLOG: 18, LA: 108 apply                                                                
                                                                msg {CI: 110}                                                                                
                                                                S2 -&gt; S1 recv heartbeat

#################################################
panic: runtime error: index out of range [-1]

goroutine 890 [running]:
6.824/raft.(*Raft).LogInfoByIndex(0xc000134100, 0xffffffffffffffff)
	/home/humborn/Code/go/MIT-6.5840/src/raft/util.go:101 +0xbd
6.824/raft.(*Raft).broadcastAppendEntries.func1(0x0)
	/home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:716 +0x84c
created by 6.824/raft.(*Raft).broadcastAppendEntries
	/home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:669 +0x15f
exit status 2</span></span></span></code></pre></div></details><details id="https://www.notion.so/f173495d21304cd9b3d005e60363aac0" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/6b4afbd6e3cb4220b1cc1a7075b3909a" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åŒæ ·çš„ï¼Œå¹¿æ’­å‘å¸ƒäº†åç¨‹åå¹¶æœªç«‹å³æ‰§è¡Œï¼Œè€Œsnapshotåœ¨åç¨‹è¿è¡Œä¹‹å‰æ›´æ–°äº†lastIncludedIndexã€‚ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°å‡ºé”™çš„Logçš„ç´¢å¼•éƒ½æ˜¯mod 10ä½™9çš„ï¼Œå¯¹åº”äº†snapshotçš„ç”Ÿæˆè§„å¾‹ï¼ŒéªŒè¯äº†çŒœæƒ³ã€‚</span></span><pre id="https://www.notion.so/212a3a5e7378442597d8723354e2d06a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.PrevLogIndex &gt; rf.logEntries[len(rf.logEntries)-1].Index ||
		rf.logEntries[args.PrevLogIndex-rf.snapshot.LastIncludedIndex].Term != args.PrevLogTerm { // ATTENTION è¿™é‡Œå¯èƒ½ä¼šè¶Šç•Œï¼Œè¦å‡å»lastincludedindex
		reply.Success = false
		DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/4b1b4e3d574f4565a1f4c238def4459c" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c785b68d6153414fb0ddb67d76ff11c9" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å°†å¹¿æ’­æ¡ä»¶ä¸­è§¦å‘å¿«ç…§åŠ è½½çš„æ¡ä»¶ç”± &lt; æ”¹ä¸º â‰¤ ã€‚</span></span><pre id="https://www.notion.so/71f94e194c2d4e1fa2175662bea7870e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>go func(id int) {
			rf.mu.Lock()
			// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“rf.nextIndex[id] == rf.logEntries[len(rf.logEntries)-1].Index+1ï¼Œå¯¹åº”çš„æ˜¯å‘é€heartbeatçš„æƒ…å†µ
			if rf.nextIndex[id] &gt; rf.logEntries[len(rf.logEntries)-1].Index+1 {
				rf.mu.Unlock()
				return
			}

			</span></span><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike"><span>if rf.nextIndex[id] &lt; rf.snapshot.LastIncludedIndex {</span></del></span><span class="SemanticString"><span>
			if rf.nextIndex[id] &lt;= rf.snapshot.LastIncludedIndex {</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/ed69e00ab7e84147803a910ddbbf1bf2" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">ApplyMsgé¡ºåºé”™ä½ç¬¬äºŒå¼¹ï¼Œè¯¦å¾ª2Cä¸­çš„ç¬¬äºŒä¸ªé—®é¢˜</span></span></del></div></div></div><details id="https://www.notion.so/346986e92c574b8d94e05c0fb45903d5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/0e0903f4554e4191913ae6aaf611fe2e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2D): snapshots basic ...
apply error: server 0 apply out of order, expected index 100, got 101
exit status 1
FAIL    6.824/raft      1.269s</span></span></span></code></pre></div></details><details id="https://www.notion.so/65bc8a7576bd47f5917652fba20a12f4" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/db81ee707f004a749266285eb4537f26" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨åŸæ¥çš„Applyå®ç°ä¸­ï¼Œå¾ªç¯ä¸­çš„cidåªè¢«åˆå§‹åŒ–äº†ä¸€æ¬¡ï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæ¯æ¬¡å¾ªç¯ä¸­ä¼šéšæ’å…¥è®°å½•çš„æ•°é‡å¢åŠ ç”Ÿæˆsnapshotï¼Œæ”¹å˜åŸæ¥çš„åˆå§‹å€¼ã€‚</span></span><pre id="https://www.notion.so/9e46f2307361424382c22d1f90f000d7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>		for cid := max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1; cid &lt;= rf.commitIndex; cid++ {
			DebugLog(dError, &quot;S%d, LENLOG: %d, LA: %d apply msg {CI: %d} \n&quot;, rf.me, len(rf.logEntries), rf.lastApplied, cid)
			msg := ApplyMsg{
				CommandValid: true,
				Command:      rf.logEntries[cid-rf.snapshot.LastIncludedIndex].Command,
				CommandIndex: cid,
			}
			rf.mu.Unlock()
			rf.applyCh &lt;- msg
			rf.mu.Lock()
		}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/292517fd444f43e4890dc0b03f8f6761" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/8bdb5d53c98b43e7be78f135c301ec84" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¤šæ¬¡åˆå§‹åŒ–ã€‚</span></span><pre id="https://www.notion.so/e9b0c164c0274b47a63fd4ba73dc74ac" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>		cid := max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1
		for cid &lt;= rf.commitIndex {
			DebugLog(dError, &quot;S%d, LENLOG: %d, LA: %d apply msg {CI: %d} \n&quot;,
				rf.me, len(rf.logEntries), rf.lastApplied, cid)
			msg := ApplyMsg{
				CommandValid: true,
				Command:      rf.logEntries[cid-rf.snapshot.LastIncludedIndex].Command,
				CommandIndex: cid,
			}
			rf.mu.Unlock()
			rf.applyCh &lt;- msg
			rf.mu.Lock()
			rf.lastApplied = cid
			cid = max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1
		}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/ddb596c63df34d50911b7087d4123bdb" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">é¦–å…ˆï¼Œå¯ä»¥çŸ¥é“ï¼Œapply out of orderæœ‰ä¸¤ç§å½¢æ€ï¼Œä¸€ç§æ˜¯æ¥æ”¶åˆ°äº†æœ‰å»¶è¿Ÿçš„ä¿¡æ¯ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯æ¥æ”¶åˆ°äº†æœªæ¥çš„ä¿¡æ¯ã€‚ä»¥InstallSnapshot RPCä¸ºä¾‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢è¿™æ®µä»£ç å¯¹å»¶è¿Ÿä¿¡æ¯è¿›è¡Œè¿‡æ»¤ã€‚ä½†æ˜¯raftçš„Termã€commitIndexå’ŒlastAppliedç­‰ç´¢å¼•éƒ½æ˜¯å®Œå¤‡çš„ï¼Œè®²é“ç†ä¸ä¼šå‡ºç°â€œæœªæ¥çš„â€ä¿¡æ¯ã€‚</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/0747c3557cd3426f88e4f0abbad28258" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if rf.commitIndex &lt; args.LastIncludedIndex {
		rf.commitIndex = args.LastIncludedIndex
	}
	if rf.lastApplied &lt; args.LastIncludedIndex {
		rf.lastApplied = args.LastIncludedIndex
	}</span></span></span></code></pre></div></div><details id="https://www.notion.so/80cf80202f514866ad9abd52b47aa21f" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/b4681f42c68b465ab2404066f1c12fdb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>apply error: server 0 apply out of order, expected index 230, got 231
exit status 1
FAIL	6.824/raft	1.852s</span></span></span></code></pre></div></details><details id="https://www.notion.so/3be6fa27897647c2b44ca3b5a789a423" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/6165ef9bb861471b8a80a4222d34f7db" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œsnapshotåœ¨ApplyChä¸­è¢«æ¥æ”¶åï¼Œä¼šä»¥è‡ªèº«çš„lastIncludedIndexåˆ·æ–°service serverçš„å¯¹åº”å‚æ•°ï¼Œé€ æˆâ€œç‰ˆæœ¬å›é€€â€ã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/40b2bbdf055440f398875a1beb905fe1" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c8fcc2e0a13f4aba8d760c1c47bafe99" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨InstallSnapshotä¸­ä¸lastAppliedè¿›è¡Œæ¯”è¾ƒåˆ¤æ–­è¿‡æ»¤â€œç‰ˆæœ¬å›é€€â€</span></span><pre id="https://www.notion.so/d3e0ac863c0e454f990a4ceeecb19994" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.LastIncludedIndex &lt;= rf.snapshot.LastIncludedIndex ||
		args.LastIncludedIndex &lt;= rf.lastApplied {
		rf.mu.Unlock()
		return
	}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/3157b400c29d48dbaa74d293e9955892" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">ä¼šæŠ¥è«åå…¶å¦™çš„é”™è¯¯</span></span></del></div></div></div><details id="https://www.notion.so/95d0368d44d34e9eb79f09fbcb797451" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/935cd0740a5b4774a86b200526c90469" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç¬¬ä¸€åˆ—çš„Indexå’ŒLIIä¸å¯¹åº”é€ æˆçš„</span></span></p></div><pre id="https://www.notion.so/31888519f9d149ada30de4f77f4a5597" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 ingestSnap: snapshot doesn&#x27;t match                                                                                                                    
m.SnapshotIndex, INDEX: 39, LII: 29                                                                                                                      
S0 C46 install snapshot, IDX: 39 T: 1,                                                                                                                   
start from 39 to 46                                                                                                                                      
#############################################################################

apply error: server 0 snapshot doesn&#x27;t match m.SnapshotIndex
exit status 1
FAIL	6.824/raft	1.041s</span></span></span></code></pre></div></details><details id="https://www.notion.so/f899c66e01f64474a15d0c72a2b4b481" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/45dbf0d14b0047c1b67ef7890d6a2133" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ç”±äºåœ¨å‰é¢çš„é—®é¢˜æ’æŸ¥ä¸­å·²ç»åŸºæœ¬è§£å†³äº†out of orderçš„é—®é¢˜ï¼Œæ¨æµ‹å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯SaveStateAndSnapshotå‡½æ•°å­˜åœ¨å…ˆåæ‰§è¡Œé¡ºåºï¼Œåç¨‹æœ‰å»¶è¿Ÿï¼Œä½¿å¾—ä¿å­˜çš„æ—¶å€™æ²¡æœ‰èµ·åˆ°æ‹¦æˆªout of orderçš„ä½œç”¨</span></span></li></ol></div></details><details id="https://www.notion.so/c799a34508a54eb5b48a188ca7ebc50c" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/624d4322b29444b0b5804ffcfdcc0bd0" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æŠŠæ‰€æœ‰çš„rf.mu.Lock()ç»Ÿç»Ÿç§»åˆ°SaveStateAndSnapshotå‡½æ•°åé¢ä¿è¯çº¿æ€§é¡ºåºã€‚</span></span></li></ol></div></details><div id="https://www.notion.so/ccce9d2d1f34495f9ab239ef233c057e" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/7f9bf796bc0047d0bf5e355c57e7e551" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run 2D              
Test (2D): snapshots basic ...
  ... Passed --   1.8  3  506  164008  235
Test (2D): install snapshots (disconnect) ...
  ... Passed --  32.9  3 2444 1245742  316
Test (2D): install snapshots (disconnect+unreliable) ...
  ... Passed --  38.7  3 3604 1300893  327
Test (2D): install snapshots (crash) ...
  ... Passed --  24.5  3 1148  879888  334
Test (2D): install snapshots (unreliable+crash) ...
  ... Passed --  33.0  3 1432  692990  322
Test (2D): crash and restart all servers ...
  ... Passed --   6.7  3  244   64312   54
PASS
ok      6.824/raft      137.622s</span></span></span></code></pre></div></div></article>
  <footer class="Footer">
  <div>&copy; èººå¹³ä»”ä¹å›­ 2023</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>